# å¥èº«å¹³å°æŠ€æœ¯æ¶æ„ä¸å¤–éƒ¨æœåŠ¡é›†æˆæ–‡æ¡£

> **æ–‡æ¡£ç‰ˆæœ¬**: v1.0
> **åˆ›å»ºæ—¥æœŸ**: 2025-01-24
> **é€‚ç”¨èŒƒå›´**: å¥èº«å¹³å°å•ä½“åº”ç”¨ï¼ˆSpring Boot 3.0.5 + Vue 3ï¼‰
> **ç»´æŠ¤è€…**: å¼€å‘å›¢é˜Ÿ

---

## ğŸ“‹ ç›®å½•

- [ä¸€ã€æŠ€æœ¯æ¶æ„æ€»è§ˆ](#ä¸€æŠ€æœ¯æ¶æ„æ€»è§ˆ)
- [äºŒã€æ ¸å¿ƒæŠ€æœ¯æ ˆè¯¦è§£](#äºŒæ ¸å¿ƒæŠ€æœ¯æ ˆè¯¦è§£)
- [ä¸‰ã€ä¸­é—´ä»¶é›†æˆæ–¹æ¡ˆ](#ä¸‰ä¸­é—´ä»¶é›†æˆæ–¹æ¡ˆ)
  - [3.1 MySQL 8.0 æ•°æ®æŒä¹…åŒ–](#31-mysql-80-æ•°æ®æŒä¹…åŒ–)
  - [3.2 Redis ç¼“å­˜ä¸ä¼šè¯ç®¡ç†](#32-redis-ç¼“å­˜ä¸ä¼šè¯ç®¡ç†)
  - [3.3 MinIO å¯¹è±¡å­˜å‚¨](#33-minio-å¯¹è±¡å­˜å‚¨)
- [å››ã€å¤–éƒ¨APIæœåŠ¡é›†æˆ](#å››å¤–éƒ¨apiæœåŠ¡é›†æˆ)
  - [4.1 é«˜å¾·åœ°å›¾API](#41-é«˜å¾·åœ°å›¾api)
  - [4.2 çŸ­ä¿¡éªŒè¯ç æœåŠ¡](#42-çŸ­ä¿¡éªŒè¯ç æœåŠ¡)
  - [4.3 æ”¯ä»˜æœåŠ¡é›†æˆ](#43-æ”¯ä»˜æœåŠ¡é›†æˆ)
- [äº”ã€é¡¹ç›®å®ç°åŠŸèƒ½æ¸…å•](#äº”é¡¹ç›®å®ç°åŠŸèƒ½æ¸…å•)
- [å…­ã€å®Œæ•´é›†æˆå®æˆ˜æŒ‡å—](#å…­å®Œæ•´é›†æˆå®æˆ˜æŒ‡å—)
- [ä¸ƒã€ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²æ¸…å•](#ä¸ƒç”Ÿäº§ç¯å¢ƒéƒ¨ç½²æ¸…å•)

---

## ä¸€ã€æŠ€æœ¯æ¶æ„æ€»è§ˆ

### 1.1 ç³»ç»Ÿæ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           å‰ç«¯å±‚ï¼ˆVue 3ï¼‰                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚      Adminç®¡ç†ç«¯              â”‚           Appç”¨æˆ·ç«¯                       â”‚
â”‚  - Element Plus UI           â”‚      - Vant 3 ç§»åŠ¨ç«¯UI                    â”‚
â”‚  - Vue Router 4              â”‚      - Vant Weapp å°ç¨‹åº                  â”‚
â”‚  - PiniaçŠ¶æ€ç®¡ç†              â”‚      - é«˜å¾·åœ°å›¾JS API                     â”‚
â”‚  - Axios HTTPå®¢æˆ·ç«¯          â”‚      - Axios HTTPå®¢æˆ·ç«¯                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚                              â”‚
               â”‚          HTTPS/HTTP          â”‚
               â”‚                              â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      åº”ç”¨å±‚ï¼ˆSpring Boot 3.0.5ï¼‰                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   web-adminæ¨¡å—               â”‚        web-appæ¨¡å—                        â”‚
â”‚   â”œâ”€ Controller              â”‚        â”œâ”€ Controller                      â”‚
â”‚   â”œâ”€ Service                 â”‚        â”œâ”€ Service                         â”‚
â”‚   â”œâ”€ Mapper                  â”‚        â”œâ”€ Mapper                          â”‚
â”‚   â””â”€ Config                  â”‚        â””â”€ Config                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                        å…±äº«å±‚ï¼ˆcommon + modelï¼‰                          â”‚
â”‚   â”œâ”€ Entityå®ä½“ç±»            â”œâ”€ DTO/VO                                   â”‚
â”‚   â”œâ”€ ç»Ÿä¸€ç»“æœå°è£…             â”œâ”€ å·¥å…·ç±»                                   â”‚
â”‚   â”œâ”€ å…¨å±€å¼‚å¸¸å¤„ç†             â”œâ”€ é…ç½®ç±»                                   â”‚
â”‚   â””â”€ ç»Ÿä¸€æ‹¦æˆªå™¨               â””â”€ å¸¸é‡å®šä¹‰                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚              â”‚              â”‚              â”‚
       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”
       â”‚   MySQL     â”‚  â”‚   Redis     â”‚ â”‚  MinIO   â”‚  â”‚ å¤–éƒ¨API    â”‚
       â”‚   æ•°æ®åº“     â”‚  â”‚   ç¼“å­˜      â”‚ â”‚ å¯¹è±¡å­˜å‚¨  â”‚  â”‚  æœåŠ¡      â”‚
       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚                â”‚              â”‚              â”‚
       â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”
       â”‚ - ä¸šåŠ¡æ•°æ®   â”‚  â”‚ - Session   â”‚ â”‚ - å›¾ç‰‡   â”‚  â”‚ - é«˜å¾·åœ°å›¾ â”‚
       â”‚ - ç”¨æˆ·ä¿¡æ¯   â”‚  â”‚ - Tokené»‘åå•â”‚ â”‚ - è§†é¢‘   â”‚  â”‚ - çŸ­ä¿¡éªŒè¯ â”‚
       â”‚ - è®¢å•è®°å½•   â”‚  â”‚ - çƒ­ç‚¹æ•°æ®   â”‚ â”‚ - æ–‡ä»¶   â”‚  â”‚ - æ”¯ä»˜ç½‘å…³ â”‚
       â”‚ - å¥åº·æ¡£æ¡ˆ   â”‚  â”‚ - é™æµè®¡æ•°   â”‚ â”‚          â”‚  â”‚           â”‚
       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.2 æŠ€æœ¯é€‰å‹ä¸€è§ˆè¡¨

| å±‚æ¬¡ | æŠ€æœ¯/ä¸­é—´ä»¶ | ç‰ˆæœ¬ | ç”¨é€” | æ˜¯å¦å¿…éœ€ |
|------|------------|------|------|---------|
| **åç«¯æ¡†æ¶** | Spring Boot | 3.0.5 | åº”ç”¨åŸºç¡€æ¡†æ¶ | âœ… å¿…éœ€ |
| **æŒä¹…å±‚** | MyBatis-Plus | 3.5.3.1 | ORMæ¡†æ¶ | âœ… å¿…éœ€ |
| **æ•°æ®åº“** | MySQL | 8.0+ | å…³ç³»å‹æ•°æ®åº“ | âœ… å¿…éœ€ |
| **ç¼“å­˜** | Redis | 7.0+ | åˆ†å¸ƒå¼ç¼“å­˜ | âœ… å¿…éœ€ |
| **å¯¹è±¡å­˜å‚¨** | MinIO | 8.2.0 | æ–‡ä»¶å­˜å‚¨ | âœ… å¿…éœ€ |
| **APIæ–‡æ¡£** | Knife4j | 4.1.0 | Swaggerå¢å¼º | âœ… å¿…éœ€ |
| **å®‰å…¨è®¤è¯** | JWT | jjwt 0.11.5 | æ— çŠ¶æ€è®¤è¯ | âœ… å¿…éœ€ |
| **JSONå¤„ç†** | Jackson | 2.14.2 | JSONåºåˆ—åŒ– | âœ… å¿…éœ€ |
| **æ—¥å¿—æ¡†æ¶** | Logback | 1.4.5 | æ—¥å¿—è®°å½• | âœ… å¿…éœ€ |
| **å¤–éƒ¨API-åœ°å›¾** | é«˜å¾·åœ°å›¾API | - | åœ°ç†ä½ç½®æœåŠ¡ | ğŸ”§ æ¨è |
| **å¤–éƒ¨API-çŸ­ä¿¡** | é˜¿é‡Œäº‘SMS / è…¾è®¯äº‘SMS | - | çŸ­ä¿¡éªŒè¯ç  | ğŸ”§ æ¨è |
| **å¤–éƒ¨API-æ”¯ä»˜** | å¾®ä¿¡æ”¯ä»˜ / æ”¯ä»˜å® | - | åœ¨çº¿æ”¯ä»˜ | ğŸš€ å¯é€‰ |
| **å‰ç«¯æ¡†æ¶** | Vue 3 | 3.3+ | æ¸è¿›å¼æ¡†æ¶ | âœ… å¿…éœ€ |
| **ç§»åŠ¨ç«¯UI** | Vant | 4.0+ | ç§»åŠ¨ç«¯ç»„ä»¶åº“ | âœ… å¿…éœ€ |
| **ç®¡ç†ç«¯UI** | Element Plus | 2.3+ | PCç«¯ç»„ä»¶åº“ | âœ… å¿…éœ€ |

**å›¾ä¾‹è¯´æ˜**ï¼š
- âœ… å¿…éœ€ï¼šé¡¹ç›®æ ¸å¿ƒä¾èµ–ï¼Œå¿…é¡»é…ç½®
- ğŸ”§ æ¨èï¼šå¢å¼ºåŠŸèƒ½ï¼Œå»ºè®®é›†æˆ
- ğŸš€ å¯é€‰ï¼šæ‰©å±•åŠŸèƒ½ï¼ŒæŒ‰éœ€é›†æˆ

---

## äºŒã€æ ¸å¿ƒæŠ€æœ¯æ ˆè¯¦è§£

### 2.1 Spring Boot 3.0.5

**é€‰å‹åŸå› **ï¼š
- Jakarta EE 9+ æ”¯æŒï¼ˆæ›¿ä»£ javax.*ï¼‰
- åŸç”Ÿæ”¯æŒ GraalVMï¼ˆå¯ç¼–è¯‘ä¸ºåŸç”Ÿé•œåƒï¼‰
- æ€§èƒ½æå‡ 30%ï¼ˆç›¸æ¯” Spring Boot 2.xï¼‰
- æœ€æ–°å®‰å…¨è¡¥ä¸å’Œç‰¹æ€§

**æ ¸å¿ƒä¾èµ–é…ç½®** (`pom.xml`)ï¼š
```xml
<!-- çˆ¶é¡¹ç›® -->
<parent>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-parent</artifactId>
    <version>3.0.5</version>
</parent>

<dependencies>
    <!-- Web Starter -->
    <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-web</artifactId>
    </dependency>

    <!-- Validation -->
    <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-validation</artifactId>
    </dependency>

    <!-- AOP -->
    <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-aop</artifactId>
    </dependency>
</dependencies>
```

**é¡¹ç›®ä¸­çš„åº”ç”¨**ï¼š
1. **ç»Ÿä¸€ç»“æœå°è£…** (`common/result/Result.java`)ï¼š
```java
@Data
@AllArgsConstructor
@NoArgsConstructor
public class Result<T> {
    private Integer code;
    private String message;
    private T data;

    public static <T> Result<T> success() {
        return new Result<>(200, "æˆåŠŸ", null);
    }

    public static <T> Result<T> success(T data) {
        return new Result<>(200, "æˆåŠŸ", data);
    }

    public static <T> Result<T> fail(String message) {
        return new Result<>(500, message, null);
    }
}
```

2. **å…¨å±€å¼‚å¸¸å¤„ç†** (`common/exception/GlobalExceptionHandler.java`)ï¼š
```java
@RestControllerAdvice
@Slf4j
public class GlobalExceptionHandler {

    // ä¸šåŠ¡å¼‚å¸¸
    @ExceptionHandler(BusinessException.class)
    public Result<Void> handleBusinessException(BusinessException e) {
        log.warn("ä¸šåŠ¡å¼‚å¸¸: {}", e.getMessage());
        return Result.fail(e.getMessage());
    }

    // å‚æ•°æ ¡éªŒå¼‚å¸¸
    @ExceptionHandler(MethodArgumentNotValidException.class)
    public Result<Void> handleValidationException(MethodArgumentNotValidException e) {
        String message = e.getBindingResult().getFieldError().getDefaultMessage();
        log.warn("å‚æ•°æ ¡éªŒå¤±è´¥: {}", message);
        return Result.fail(message);
    }

    // ç³»ç»Ÿå¼‚å¸¸
    @ExceptionHandler(Exception.class)
    public Result<Void> handleException(Exception e) {
        log.error("ç³»ç»Ÿå¼‚å¸¸", e);
        return Result.fail("ç³»ç»Ÿç¹å¿™ï¼Œè¯·ç¨åé‡è¯•");
    }
}
```

---

### 2.2 MyBatis-Plus 3.5.3.1

**é€‰å‹åŸå› **ï¼š
- CRUD é›¶ SQL é…ç½®ï¼ˆç»§æ‰¿ BaseMapperï¼‰
- å¼ºå¤§çš„æ¡ä»¶æ„é€ å™¨ï¼ˆLambdaQueryWrapperï¼‰
- å†…ç½®åˆ†é¡µæ’ä»¶ï¼ˆPageï¼‰
- è‡ªåŠ¨å¡«å……ï¼ˆcreateTime/updateTimeï¼‰
- é€»è¾‘åˆ é™¤æ”¯æŒ

**ä¾èµ–é…ç½®**ï¼š
```xml
<dependency>
    <groupId>com.baomidou</groupId>
    <artifactId>mybatis-plus-boot-starter</artifactId>
    <version>3.5.3.1</version>
</dependency>
```

**é…ç½®æ–‡ä»¶** (`application.yml`)ï¼š
```yaml
mybatis-plus:
  # Mapper XML æ–‡ä»¶ä½ç½®
  mapper-locations: classpath*:mapper/**/*.xml

  # å®ä½“ç±»åŒ…è·¯å¾„
  type-aliases-package: com.huang.model.entity

  # å…¨å±€é…ç½®
  global-config:
    db-config:
      # ä¸»é”®ç­–ç•¥ï¼ˆé›ªèŠ±ç®—æ³•ï¼‰
      id-type: ASSIGN_ID
      # é€»è¾‘åˆ é™¤å­—æ®µ
      logic-delete-field: isDeleted
      logic-delete-value: 1
      logic-not-delete-value: 0

  # MyBatis åŸç”Ÿé…ç½®
  configuration:
    # é©¼å³°è½¬ä¸‹åˆ’çº¿
    map-underscore-to-camel-case: true
    # æ—¥å¿—è¾“å‡ºï¼ˆå¼€å‘ç¯å¢ƒï¼‰
    log-impl: org.apache.ibatis.logging.stdout.StdOutImpl
```

**é¡¹ç›®ä¸­çš„åº”ç”¨**ï¼š

1. **BaseEntity åŸºç±»**ï¼š
```java
@Data
public class BaseEntity {
    @TableId(type = IdType.ASSIGN_ID)
    private Long id;

    @TableField(fill = FieldFill.INSERT)
    private LocalDateTime createTime;

    @TableField(fill = FieldFill.INSERT_UPDATE)
    private LocalDateTime updateTime;

    @TableLogic
    private Byte isDeleted;
}
```

2. **è‡ªåŠ¨å¡«å……å¤„ç†å™¨**ï¼š
```java
@Component
public class MyMetaObjectHandler implements MetaObjectHandler {

    @Override
    public void insertFill(MetaObject metaObject) {
        this.strictInsertFill(metaObject, "createTime", LocalDateTime.class, LocalDateTime.now());
        this.strictInsertFill(metaObject, "updateTime", LocalDateTime.class, LocalDateTime.now());
        this.strictInsertFill(metaObject, "isDeleted", Byte.class, (byte) 0);
    }

    @Override
    public void updateFill(MetaObject metaObject) {
        this.strictUpdateFill(metaObject, "updateTime", LocalDateTime.class, LocalDateTime.now());
    }
}
```

3. **åˆ†é¡µæ’ä»¶é…ç½®**ï¼š
```java
@Configuration
public class MybatisPlusConfig {

    @Bean
    public MybatisPlusInterceptor mybatisPlusInterceptor() {
        MybatisPlusInterceptor interceptor = new MybatisPlusInterceptor();

        // åˆ†é¡µæ’ä»¶
        interceptor.addInnerInterceptor(new PaginationInnerInterceptor(DbType.MYSQL));

        // ä¹è§‚é”æ’ä»¶
        interceptor.addInnerInterceptor(new OptimisticLockerInnerInterceptor());

        return interceptor;
    }
}
```

4. **Serviceå±‚ä½¿ç”¨ç¤ºä¾‹**ï¼ˆé—¨åº—ç®¡ç†ï¼‰ï¼š
```java
@Service
@RequiredArgsConstructor
public class GymStoreServiceImpl extends ServiceImpl<GymStoreMapper, GymStore>
        implements GymStoreService {

    @Override
    public Page<GymStoreListVO> getStoreListPage(GymStoreQueryDTO queryDTO) {
        // æ„å»ºåˆ†é¡µå¯¹è±¡
        Page<GymStore> page = new Page<>(queryDTO.getCurrent(), queryDTO.getSize());

        // æ„å»ºæŸ¥è¯¢æ¡ä»¶
        LambdaQueryWrapper<GymStore> wrapper = new LambdaQueryWrapper<>();
        wrapper.eq(GymStore::getIsDeleted, (byte) 0)  // é€»è¾‘åˆ é™¤è¿‡æ»¤
               .like(StringUtils.hasText(queryDTO.getStoreName()),
                     GymStore::getStoreName, queryDTO.getStoreName())
               .like(StringUtils.hasText(queryDTO.getAddress()),
                     GymStore::getAddress, queryDTO.getAddress())
               .eq(queryDTO.getStatus() != null,
                   GymStore::getStatus, queryDTO.getStatus())
               .orderByDesc(GymStore::getCreateTime);

        // æ‰§è¡Œåˆ†é¡µæŸ¥è¯¢
        Page<GymStore> resultPage = this.page(page, wrapper);

        // è½¬æ¢ä¸ºVO
        return convertToVO(resultPage);
    }
}
```

---

### 2.3 JWTï¼ˆJSON Web Tokenï¼‰è®¤è¯

**é€‰å‹åŸå› **ï¼š
- æ— çŠ¶æ€è®¤è¯ï¼ˆæœåŠ¡ç«¯ä¸å­˜å‚¨Sessionï¼‰
- è·¨åŸŸå‹å¥½ï¼ˆæ”¯æŒç§»åŠ¨ç«¯/å°ç¨‹åºï¼‰
- åŒ…å«ç”¨æˆ·ä¿¡æ¯ï¼ˆå‡å°‘æ•°æ®åº“æŸ¥è¯¢ï¼‰
- æ”¯æŒåˆ†å¸ƒå¼éƒ¨ç½²

**ä¾èµ–é…ç½®**ï¼š
```xml
<dependency>
    <groupId>io.jsonwebtoken</groupId>
    <artifactId>jjwt-api</artifactId>
    <version>0.11.5</version>
</dependency>
<dependency>
    <groupId>io.jsonwebtoken</groupId>
    <artifactId>jjwt-impl</artifactId>
    <version>0.11.5</version>
    <scope>runtime</scope>
</dependency>
<dependency>
    <groupId>io.jsonwebtoken</groupId>
    <artifactId>jjwt-jackson</artifactId>
    <version>0.11.5</version>
    <scope>runtime</scope>
</dependency>
```

**é¡¹ç›®ä¸­çš„åº”ç”¨**ï¼š

1. **JWTå·¥å…·ç±»** (`common/util/JwtUtil.java`)ï¼š
```java
@Component
public class JwtUtil {

    @Value("${jwt.secret}")
    private String secret;  // å¯†é’¥ï¼ˆè‡³å°‘256ä½ï¼‰

    @Value("${jwt.expiration}")
    private Long expiration;  // è¿‡æœŸæ—¶é—´ï¼ˆæ¯«ç§’ï¼‰

    // ç”ŸæˆToken
    public String generateToken(Long userId, String phone) {
        Date now = new Date();
        Date expiryDate = new Date(now.getTime() + expiration);

        return Jwts.builder()
                .setSubject(userId.toString())  // ç”¨æˆ·ID
                .claim("phone", phone)          // æ‰‹æœºå·
                .setIssuedAt(now)               // ç­¾å‘æ—¶é—´
                .setExpiration(expiryDate)      // è¿‡æœŸæ—¶é—´
                .signWith(getSignKey(), SignatureAlgorithm.HS256)  // ç­¾åç®—æ³•
                .compact();
    }

    // è§£æToken
    public Claims parseToken(String token) {
        return Jwts.parserBuilder()
                .setSigningKey(getSignKey())
                .build()
                .parseClaimsJws(token)
                .getBody();
    }

    // ä»Tokenè·å–ç”¨æˆ·ID
    public Long getUserIdFromToken(String token) {
        Claims claims = parseToken(token);
        return Long.parseLong(claims.getSubject());
    }

    // éªŒè¯Tokenæ˜¯å¦è¿‡æœŸ
    public boolean isTokenExpired(String token) {
        try {
            Claims claims = parseToken(token);
            return claims.getExpiration().before(new Date());
        } catch (ExpiredJwtException e) {
            return true;
        }
    }

    // è·å–ç­¾åå¯†é’¥
    private Key getSignKey() {
        byte[] keyBytes = Decoders.BASE64.decode(secret);
        return Keys.hmacShaKeyFor(keyBytes);
    }
}
```

2. **ç™»å½•æ¥å£ç”ŸæˆToken** (`web-app/controller/AuthController.java`)ï¼š
```java
@RestController
@RequestMapping("/app/auth")
@RequiredArgsConstructor
public class AuthController {

    private final AuthService authService;
    private final JwtUtil jwtUtil;

    @PostMapping("/login")
    public Result<LoginVO> login(@Valid @RequestBody LoginDTO loginDTO) {
        // 1. éªŒè¯æ‰‹æœºå·å’ŒéªŒè¯ç 
        User user = authService.verifyLoginCredentials(loginDTO);

        // 2. ç”ŸæˆJWT Token
        String token = jwtUtil.generateToken(user.getId(), user.getPhone());

        // 3. è¿”å›ç”¨æˆ·ä¿¡æ¯å’ŒToken
        LoginVO loginVO = new LoginVO();
        loginVO.setToken(token);
        loginVO.setUserId(user.getId());
        loginVO.setNickname(user.getNickname());
        loginVO.setAvatar(user.getAvatar());

        return Result.success(loginVO);
    }
}
```

3. **Tokenæ‹¦æˆªå™¨** (`common/interceptor/JwtInterceptor.java`)ï¼š
```java
@Component
@RequiredArgsConstructor
public class JwtInterceptor implements HandlerInterceptor {

    private final JwtUtil jwtUtil;
    private final RedisTemplate<String, String> redisTemplate;

    @Override
    public boolean preHandle(HttpServletRequest request,
                            HttpServletResponse response,
                            Object handler) {
        // 1. è·å–Token
        String token = request.getHeader("Authorization");
        if (token == null || !token.startsWith("Bearer ")) {
            throw new UnauthorizedException("æœªç™»å½•æˆ–Tokenæ— æ•ˆ");
        }

        token = token.substring(7);  // ç§»é™¤ "Bearer " å‰ç¼€

        // 2. éªŒè¯Tokenæ˜¯å¦åœ¨é»‘åå•ï¼ˆå·²é€€å‡ºç™»å½•ï¼‰
        String blacklistKey = "token:blacklist:" + token;
        if (Boolean.TRUE.equals(redisTemplate.hasKey(blacklistKey))) {
            throw new UnauthorizedException("Tokenå·²å¤±æ•ˆï¼Œè¯·é‡æ–°ç™»å½•");
        }

        // 3. è§£æToken
        try {
            Long userId = jwtUtil.getUserIdFromToken(token);

            // 4. å°†ç”¨æˆ·IDå­˜å…¥ThreadLocalï¼ˆä¾›Controllerä½¿ç”¨ï¼‰
            UserContext.setUserId(userId);

            return true;
        } catch (Exception e) {
            throw new UnauthorizedException("Tokenè§£æå¤±è´¥");
        }
    }

    @Override
    public void afterCompletion(HttpServletRequest request,
                                HttpServletResponse response,
                                Object handler,
                                Exception ex) {
        // æ¸…ç†ThreadLocalï¼Œé˜²æ­¢å†…å­˜æ³„æ¼
        UserContext.clear();
    }
}
```

4. **é…ç½®æ‹¦æˆªå™¨** (`common/config/WebConfig.java`)ï¼š
```java
@Configuration
@RequiredArgsConstructor
public class WebConfig implements WebMvcConfigurer {

    private final JwtInterceptor jwtInterceptor;

    @Override
    public void addInterceptors(InterceptorRegistry registry) {
        registry.addInterceptor(jwtInterceptor)
                .addPathPatterns("/app/**")  // æ‹¦æˆªAppç«¯æ‰€æœ‰æ¥å£
                .excludePathPatterns(
                    "/app/auth/login",       // æ”¾è¡Œç™»å½•æ¥å£
                    "/app/auth/register",    // æ”¾è¡Œæ³¨å†Œæ¥å£
                    "/app/auth/send-code"    // æ”¾è¡Œå‘é€éªŒè¯ç 
                );
    }
}
```

---

### 2.4 Knife4j APIæ–‡æ¡£

**é€‰å‹åŸå› **ï¼š
- Swagger 3ï¼ˆOpenAPI 3.0ï¼‰å¢å¼ºç‰ˆ
- ç²¾ç¾çš„UIç•Œé¢
- æ”¯æŒåˆ†ç»„ç®¡ç†
- åœ¨çº¿è°ƒè¯•åŠŸèƒ½

**ä¾èµ–é…ç½®**ï¼š
```xml
<dependency>
    <groupId>com.github.xiaoymin</groupId>
    <artifactId>knife4j-openapi3-jakarta-spring-boot-starter</artifactId>
    <version>4.1.0</version>
</dependency>
```

**é¡¹ç›®ä¸­çš„åº”ç”¨**ï¼ˆå·²åœ¨é—¨åº—ç®¡ç†ä¸­å®ç°ï¼‰ï¼š
```java
@Configuration
public class Knife4jConfiguration {

    @Bean
    public OpenAPI customOpenAPI() {
        return new OpenAPI()
                .info(new Info()
                        .title("å¥èº«å¹³å°API")
                        .version("1.0")
                        .description("æ¥å£æ–‡æ¡£"))
                .addSecurityItem(new SecurityRequirement().addList("BearerAuth"))
                .components(new Components()
                        .addSecuritySchemes("BearerAuth",
                                new SecurityScheme()
                                        .type(SecurityScheme.Type.HTTP)
                                        .scheme("bearer")
                                        .bearerFormat("JWT")));
    }

    @Bean
    public GroupedOpenApi storeManagementAPI() {
        return GroupedOpenApi.builder()
                .group("10-é—¨åº—ç®¡ç†")
                .pathsToMatch("/admin/gym-store/**")
                .build();
    }
}
```

**è®¿é—®åœ°å€**ï¼š
- Swagger UIï¼š`http://localhost:8080/doc.html`
- OpenAPI JSONï¼š`http://localhost:8080/v3/api-docs`

---

## ä¸‰ã€ä¸­é—´ä»¶é›†æˆæ–¹æ¡ˆ

### 3.1 MySQL 8.0 æ•°æ®æŒä¹…åŒ–

#### 3.1.1 æŠ€æœ¯ç‰¹æ€§

**é€‰å‹åŸå› **ï¼š
- âœ… JSONå­—æ®µåŸç”Ÿæ”¯æŒï¼ˆ`facilities` å­—æ®µå­˜å‚¨é—¨åº—è®¾æ–½ä¿¡æ¯ï¼‰
- âœ… ç©ºé—´ç´¢å¼•ï¼ˆåœ°ç†ä½ç½®æŸ¥è¯¢ä¼˜åŒ–ï¼‰
- âœ… çª—å£å‡½æ•°ï¼ˆå¤æ‚ç»Ÿè®¡æŸ¥è¯¢ï¼‰
- âœ… CTEé€’å½’æŸ¥è¯¢ï¼ˆç»„ç»‡æ¶æ„æ ‘ï¼‰
- âœ… InnoDBå¼•æ“å¢å¼ºï¼ˆæ€§èƒ½æå‡40%ï¼‰

#### 3.1.2 é¡¹ç›®ä¸­çš„åº”ç”¨

**1. JSONå­—æ®µå­˜å‚¨**ï¼ˆ`gym_store` è¡¨ï¼‰ï¼š
```sql
CREATE TABLE gym_store (
    id BIGINT PRIMARY KEY,
    store_name VARCHAR(50) NOT NULL,

    -- JSONå­—æ®µå­˜å‚¨è®¾æ–½ä¿¡æ¯
    facilities JSON COMMENT 'è®¾æ–½ä¿¡æ¯: {"hasParking":true,"hasShower":true,...}',

    -- JSONå­—æ®µå­˜å‚¨å›¾ç‰‡æ•°ç»„
    images JSON COMMENT 'é—¨åº—å›¾ç‰‡: ["url1","url2",...]',

    -- åœ°ç†ä½ç½®å­—æ®µ
    latitude DECIMAL(10, 6) COMMENT 'çº¬åº¦',
    longitude DECIMAL(10, 6) COMMENT 'ç»åº¦',

    -- ç´¢å¼•
    INDEX idx_location (latitude, longitude),
    INDEX idx_status (status, is_deleted)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='é—¨åº—ä¿¡æ¯è¡¨';
```

**2. JSONå­—æ®µæŸ¥è¯¢**ï¼š
```sql
-- æŸ¥è¯¢æœ‰åœè½¦åœºçš„é—¨åº—
SELECT * FROM gym_store
WHERE JSON_EXTRACT(facilities, '$.hasParking') = true;

-- æŸ¥è¯¢å›¾ç‰‡æ•°é‡å¤§äº3çš„é—¨åº—
SELECT * FROM gym_store
WHERE JSON_LENGTH(images) > 3;

-- æ›´æ–°JSONå­—æ®µ
UPDATE gym_store
SET facilities = JSON_SET(facilities, '$.equipmentCount', 200)
WHERE id = 1;
```

**3. ç©ºé—´ç´¢å¼•ä¼˜åŒ–**ï¼ˆMySQL 8.0+ï¼‰ï¼š
```sql
-- åˆ›å»ºç©ºé—´ç´¢å¼•ï¼ˆéœ€è¦POINTç±»å‹ï¼‰
ALTER TABLE gym_store ADD COLUMN location POINT;

-- æ›´æ–°ç©ºé—´å­—æ®µ
UPDATE gym_store
SET location = ST_GeomFromText(CONCAT('POINT(', longitude, ' ', latitude, ')'), 4326);

-- åˆ›å»ºç©ºé—´ç´¢å¼•
CREATE SPATIAL INDEX idx_spatial_location ON gym_store(location);

-- ç©ºé—´æŸ¥è¯¢ï¼ˆçŸ©å½¢åŒºåŸŸç­›é€‰ï¼Œæ¯”Haversineå¿«10å€ï¼‰
SELECT * FROM gym_store
WHERE ST_Distance_Sphere(
    location,
    ST_GeomFromText('POINT(116.3972 39.9075)', 4326)
) <= 10000;  -- 10å…¬é‡Œ
```

#### 3.1.3 è¿æ¥é…ç½®

**application.yml**ï¼š
```yaml
spring:
  datasource:
    driver-class-name: com.mysql.cj.jdbc.Driver
    url: jdbc:mysql://localhost:3306/fitness_platform?useUnicode=true&characterEncoding=utf8&useSSL=false&serverTimezone=Asia/Shanghai&allowPublicKeyRetrieval=true
    username: root
    password: your_password

    # HikariCPè¿æ¥æ± é…ç½®ï¼ˆSpring Boot 3.xé»˜è®¤ï¼‰
    hikari:
      minimum-idle: 5                # æœ€å°ç©ºé—²è¿æ¥
      maximum-pool-size: 20          # æœ€å¤§è¿æ¥æ•°
      connection-timeout: 30000      # è¿æ¥è¶…æ—¶ï¼ˆæ¯«ç§’ï¼‰
      idle-timeout: 600000           # ç©ºé—²è¶…æ—¶ï¼ˆ10åˆ†é’Ÿï¼‰
      max-lifetime: 1800000          # è¿æ¥æœ€å¤§å­˜æ´»æ—¶é—´ï¼ˆ30åˆ†é’Ÿï¼‰
```

#### 3.1.4 å®ç°åŠŸèƒ½æ¸…å•

| åŠŸèƒ½æ¨¡å— | è¡¨å | æ ¸å¿ƒå­—æ®µ | ç‰¹æ®ŠæŠ€æœ¯ |
|---------|------|---------|---------|
| ç”¨æˆ·ç®¡ç† | `user` | phone, password_hash | BCryptåŠ å¯† |
| é—¨åº—ç®¡ç† | `gym_store` | latitude, longitude, facilities(JSON) | ç©ºé—´ç´¢å¼•, JSON |
| å¥åº·æ¡£æ¡ˆ | `health_record` | user_id, body_data(JSON) | JSONå­—æ®µ |
| è¯¾ç¨‹ç®¡ç† | `course`, `course_schedule` | start_time, end_time | æ—¶é—´èŒƒå›´æŸ¥è¯¢ |
| è®¢å•æ”¯ä»˜ | `order_info`, `payment_record` | order_no, transaction_id | äº‹åŠ¡ä¸€è‡´æ€§ |
| æ•™ç»ƒç®¡ç† | `coach`, `coach_certification` | rating, service_count | èšåˆç»Ÿè®¡ |

---

### 3.2 Redis ç¼“å­˜ä¸ä¼šè¯ç®¡ç†

#### 3.2.1 æŠ€æœ¯ç‰¹æ€§

**é€‰å‹åŸå› **ï¼š
- âœ… é«˜æ€§èƒ½ç¼“å­˜ï¼ˆQPS 10ä¸‡+ï¼‰
- âœ… åˆ†å¸ƒå¼Sessionå­˜å‚¨
- âœ… Tokené»‘åå•ç®¡ç†
- âœ… é™æµè®¡æ•°å™¨
- âœ… çƒ­ç‚¹æ•°æ®ç¼“å­˜

**ä¾èµ–é…ç½®**ï¼š
```xml
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-data-redis</artifactId>
</dependency>
<dependency>
    <groupId>org.apache.commons</groupId>
    <artifactId>commons-pool2</artifactId>  <!-- Lettuceè¿æ¥æ±  -->
</dependency>
```

#### 3.2.2 è¿æ¥é…ç½®

**application.yml**ï¼š
```yaml
spring:
  data:
    redis:
      host: localhost
      port: 6379
      password: your_password
      database: 0           # Adminç«¯ä½¿ç”¨db0

      # Lettuceè¿æ¥æ± é…ç½®
      lettuce:
        pool:
          max-active: 8     # æœ€å¤§è¿æ¥æ•°
          max-idle: 8       # æœ€å¤§ç©ºé—²è¿æ¥
          min-idle: 2       # æœ€å°ç©ºé—²è¿æ¥
          max-wait: 3000ms  # è·å–è¿æ¥æœ€å¤§ç­‰å¾…æ—¶é—´

      # è¿æ¥è¶…æ—¶
      timeout: 5000ms
```

#### 3.2.3 Redisé…ç½®ç±»

```java
@Configuration
@EnableCaching
public class RedisConfig {

    @Bean
    public RedisTemplate<String, Object> redisTemplate(RedisConnectionFactory factory) {
        RedisTemplate<String, Object> template = new RedisTemplate<>();
        template.setConnectionFactory(factory);

        // ä½¿ç”¨Jacksonåºåˆ—åŒ–
        Jackson2JsonRedisSerializer<Object> serializer = new Jackson2JsonRedisSerializer<>(Object.class);
        ObjectMapper mapper = new ObjectMapper();
        mapper.setVisibility(PropertyAccessor.ALL, JsonAutoDetect.Visibility.ANY);
        mapper.activateDefaultTyping(
            mapper.getPolymorphicTypeValidator(),
            ObjectMapper.DefaultTyping.NON_FINAL
        );
        serializer.setObjectMapper(mapper);

        // Keyä½¿ç”¨Stringåºåˆ—åŒ–
        template.setKeySerializer(new StringRedisSerializer());
        template.setHashKeySerializer(new StringRedisSerializer());

        // Valueä½¿ç”¨JSONåºåˆ—åŒ–
        template.setValueSerializer(serializer);
        template.setHashValueSerializer(serializer);

        template.afterPropertiesSet();
        return template;
    }

    @Bean
    public CacheManager cacheManager(RedisConnectionFactory factory) {
        RedisCacheConfiguration config = RedisCacheConfiguration.defaultCacheConfig()
                .entryTtl(Duration.ofMinutes(30))  // é»˜è®¤è¿‡æœŸæ—¶é—´30åˆ†é’Ÿ
                .disableCachingNullValues();       // ä¸ç¼“å­˜nullå€¼

        return RedisCacheManager.builder(factory)
                .cacheDefaults(config)
                .build();
    }
}
```

#### 3.2.4 é¡¹ç›®ä¸­çš„åº”ç”¨

**1. Tokené»‘åå•ç®¡ç†**ï¼ˆç”¨æˆ·é€€å‡ºç™»å½•ï¼‰ï¼š
```java
@Service
@RequiredArgsConstructor
public class AuthServiceImpl implements AuthService {

    private final RedisTemplate<String, String> redisTemplate;
    private final JwtUtil jwtUtil;

    @Override
    public void logout(String token) {
        // 1. è§£æTokenè·å–è¿‡æœŸæ—¶é—´
        Claims claims = jwtUtil.parseToken(token);
        Date expiration = claims.getExpiration();
        long ttl = expiration.getTime() - System.currentTimeMillis();

        // 2. å°†TokenåŠ å…¥é»‘åå•ï¼Œè¿‡æœŸæ—¶é—´ä¸Tokenä¸€è‡´
        String blacklistKey = "token:blacklist:" + token;
        redisTemplate.opsForValue().set(blacklistKey, "1", ttl, TimeUnit.MILLISECONDS);
    }
}
```

**2. éªŒè¯ç å­˜å‚¨**ï¼ˆ5åˆ†é’Ÿæœ‰æ•ˆæœŸï¼‰ï¼š
```java
@Service
@RequiredArgsConstructor
public class SmsService {

    private final RedisTemplate<String, String> redisTemplate;

    // å‘é€éªŒè¯ç 
    public void sendVerificationCode(String phone) {
        // 1. ç”Ÿæˆ6ä½éšæœºéªŒè¯ç 
        String code = String.format("%06d", new Random().nextInt(999999));

        // 2. å­˜å…¥Redisï¼ˆ5åˆ†é’Ÿè¿‡æœŸï¼‰
        String key = "sms:code:" + phone;
        redisTemplate.opsForValue().set(key, code, 5, TimeUnit.MINUTES);

        // 3. è°ƒç”¨çŸ­ä¿¡æœåŠ¡å‘é€ï¼ˆè§åæ–‡ï¼‰
        sendSms(phone, code);
    }

    // éªŒè¯éªŒè¯ç 
    public boolean verifyCode(String phone, String code) {
        String key = "sms:code:" + phone;
        String storedCode = redisTemplate.opsForValue().get(key);

        if (code.equals(storedCode)) {
            // éªŒè¯æˆåŠŸååˆ é™¤éªŒè¯ç ï¼ˆé˜²æ­¢é‡å¤ä½¿ç”¨ï¼‰
            redisTemplate.delete(key);
            return true;
        }
        return false;
    }
}
```

**3. çƒ­ç‚¹æ•°æ®ç¼“å­˜**ï¼ˆé—¨åº—è¯¦æƒ…ï¼‰ï¼š
```java
@Service
@RequiredArgsConstructor
public class GymStoreServiceImpl implements GymStoreService {

    private final GymStoreMapper gymStoreMapper;
    private final RedisTemplate<String, Object> redisTemplate;

    @Override
    @Cacheable(value = "store:detail", key = "#id", unless = "#result == null")
    public GymStoreDetailVO getStoreDetail(Long id) {
        // 1. å°è¯•ä»Redisç¼“å­˜è·å–
        String cacheKey = "store:detail:" + id;
        GymStoreDetailVO cached = (GymStoreDetailVO) redisTemplate.opsForValue().get(cacheKey);
        if (cached != null) {
            return cached;
        }

        // 2. ç¼“å­˜æœªå‘½ä¸­ï¼ŒæŸ¥è¯¢æ•°æ®åº“
        GymStoreDetailVO detailVO = gymStoreMapper.selectStoreDetail(id);
        if (detailVO == null) {
            throw new BusinessException("é—¨åº—ä¸å­˜åœ¨");
        }

        // 3. å†™å…¥Redisç¼“å­˜ï¼ˆ30åˆ†é’Ÿè¿‡æœŸï¼‰
        redisTemplate.opsForValue().set(cacheKey, detailVO, 30, TimeUnit.MINUTES);
        return detailVO;
    }

    @Override
    @CacheEvict(value = "store:detail", key = "#updateDTO.id")
    public void updateStore(GymStoreUpdateDTO updateDTO) {
        // æ›´æ–°æ•°æ®åº“
        GymStore gymStore = BeanUtil.copyProperties(updateDTO, GymStore.class);
        this.updateById(gymStore);

        // æ³¨è§£è‡ªåŠ¨åˆ é™¤ç¼“å­˜
    }
}
```

**4. æ¥å£é™æµ**ï¼ˆé˜²æ­¢æ¶æ„è¯·æ±‚ï¼‰ï¼š
```java
@Aspect
@Component
@RequiredArgsConstructor
public class RateLimitAspect {

    private final RedisTemplate<String, String> redisTemplate;

    @Around("@annotation(rateLimit)")
    public Object around(ProceedingJoinPoint point, RateLimit rateLimit) throws Throwable {
        // 1. è·å–é™æµkeyï¼ˆIPåœ°å€æˆ–ç”¨æˆ·IDï¼‰
        String key = "rate_limit:" + getClientIP() + ":" + point.getSignature().toShortString();

        // 2. è·å–å½“å‰è®¡æ•°
        String countStr = redisTemplate.opsForValue().get(key);
        int count = countStr == null ? 0 : Integer.parseInt(countStr);

        // 3. åˆ¤æ–­æ˜¯å¦è¶…è¿‡é™æµé˜ˆå€¼
        if (count >= rateLimit.maxCount()) {
            throw new BusinessException("è¯·æ±‚è¿‡äºé¢‘ç¹ï¼Œè¯·ç¨åå†è¯•");
        }

        // 4. è®¡æ•°å™¨+1
        redisTemplate.opsForValue().increment(key);

        // 5. è®¾ç½®è¿‡æœŸæ—¶é—´ï¼ˆé¦–æ¬¡è¯·æ±‚æ—¶ï¼‰
        if (count == 0) {
            redisTemplate.expire(key, rateLimit.time(), rateLimit.timeUnit());
        }

        // 6. æ‰§è¡Œä¸šåŠ¡æ–¹æ³•
        return point.proceed();
    }
}

// ä½¿ç”¨ç¤ºä¾‹
@RestController
public class AuthController {

    @RateLimit(maxCount = 5, time = 1, timeUnit = TimeUnit.MINUTES)  // 1åˆ†é’Ÿæœ€å¤š5æ¬¡
    @PostMapping("/send-code")
    public Result<Void> sendCode(@RequestParam String phone) {
        // å‘é€éªŒè¯ç é€»è¾‘
    }
}
```

**5. åˆ†å¸ƒå¼é”**ï¼ˆé˜²æ­¢é‡å¤ä¸‹å•ï¼‰ï¼š
```java
@Service
@RequiredArgsConstructor
public class OrderService {

    private final RedisTemplate<String, String> redisTemplate;

    public void createOrder(CreateOrderDTO orderDTO) {
        Long userId = UserContext.getUserId();
        String lockKey = "order:lock:" + userId;

        // å°è¯•è·å–åˆ†å¸ƒå¼é”ï¼ˆ10ç§’è¶…æ—¶ï¼‰
        Boolean locked = redisTemplate.opsForValue()
                .setIfAbsent(lockKey, "1", 10, TimeUnit.SECONDS);

        if (Boolean.FALSE.equals(locked)) {
            throw new BusinessException("è®¢å•åˆ›å»ºä¸­ï¼Œè¯·å‹¿é‡å¤æäº¤");
        }

        try {
            // æ‰§è¡Œä¸‹å•é€»è¾‘
            doCreateOrder(orderDTO);
        } finally {
            // é‡Šæ”¾é”
            redisTemplate.delete(lockKey);
        }
    }
}
```

#### 3.2.5 å®ç°åŠŸèƒ½æ¸…å•

| åŠŸèƒ½ | Redisæ•°æ®ç±»å‹ | Keyæ ¼å¼ | è¿‡æœŸæ—¶é—´ | ç”¨é€” |
|------|--------------|---------|---------|------|
| Tokené»‘åå• | String | `token:blacklist:{token}` | Tokenå‰©ä½™æ—¶é—´ | é€€å‡ºç™»å½• |
| éªŒè¯ç  | String | `sms:code:{phone}` | 5åˆ†é’Ÿ | ç™»å½•/æ³¨å†Œ |
| é—¨åº—è¯¦æƒ…ç¼“å­˜ | String | `store:detail:{id}` | 30åˆ†é’Ÿ | çƒ­ç‚¹æ•°æ® |
| é™æµè®¡æ•°å™¨ | String | `rate_limit:{ip}:{method}` | è‡ªå®šä¹‰ | æ¥å£é˜²åˆ· |
| åˆ†å¸ƒå¼é” | String | `order:lock:{userId}` | 10ç§’ | é˜²é‡å¤ä¸‹å• |
| ç”¨æˆ·Session | Hash | `session:{userId}` | 24å°æ—¶ | å¤šç«¯ç™»å½• |
| é™„è¿‘é—¨åº— | Geo | `store:location` | æ°¸ä¹… | åœ°ç†ä½ç½®æŸ¥è¯¢ |

---

### 3.3 MinIO å¯¹è±¡å­˜å‚¨

#### 3.3.1 æŠ€æœ¯ç‰¹æ€§

**é€‰å‹åŸå› **ï¼š
- âœ… å¼€æºå…è´¹ï¼ˆvs é˜¿é‡Œäº‘OSSæŒ‰é‡æ”¶è´¹ï¼‰
- âœ… S3 APIå…¼å®¹ï¼ˆå¯æ— ç¼è¿ç§»ï¼‰
- âœ… é«˜æ€§èƒ½ï¼ˆå•èŠ‚ç‚¹ 100+ GB/sï¼‰
- âœ… æ”¯æŒçº åˆ ç ï¼ˆæ•°æ®å†—ä½™ä¿æŠ¤ï¼‰
- âœ… ç§æœ‰åŒ–éƒ¨ç½²ï¼ˆæ•°æ®å®‰å…¨å¯æ§ï¼‰

**ä¸äº‘å­˜å‚¨å¯¹æ¯”**ï¼š

| ç‰¹æ€§ | MinIO | é˜¿é‡Œäº‘OSS | è…¾è®¯äº‘COS |
|------|-------|----------|----------|
| æˆæœ¬ | å…è´¹ï¼ˆè‡ªå»ºæœåŠ¡å™¨ï¼‰ | 0.12å…ƒ/GB/æœˆ + æµé‡è´¹ | 0.118å…ƒ/GB/æœˆ + æµé‡è´¹ |
| éƒ¨ç½² | æœ¬åœ°/ç§æœ‰äº‘ | å…¬æœ‰äº‘ | å…¬æœ‰äº‘ |
| å¸¦å®½ | å±€åŸŸç½‘åƒå…† | å—è¿è¥å•†é™åˆ¶ | å—è¿è¥å•†é™åˆ¶ |
| CDN | éœ€è‡ªå»º | å†…ç½®CDN | å†…ç½®CDN |
| é€‚ç”¨åœºæ™¯ | å¼€å‘æµ‹è¯•/å†…ç½‘åº”ç”¨ | ç”Ÿäº§ç¯å¢ƒ/å…¬ç½‘è®¿é—® | ç”Ÿäº§ç¯å¢ƒ/å…¬ç½‘è®¿é—® |

#### 3.3.2 ä¾èµ–é…ç½®

```xml
<dependency>
    <groupId>io.minio</groupId>
    <artifactId>minio</artifactId>
    <version>8.2.0</version>
</dependency>
```

#### 3.3.3 å®Œæ•´é…ç½®ä¸å®ç°

**1. é…ç½®å±æ€§ç±»** (`common/config/MinioProperties.java`)ï¼š
```java
@Data
@Configuration
@ConfigurationProperties(prefix = "minio")
public class MinioProperties {
    private String endpoint;      // MinIOæœåŠ¡åœ°å€: http://localhost:9000
    private String accessKey;     // è®¿é—®å¯†é’¥ï¼ˆé»˜è®¤ minioadminï¼‰
    private String secretKey;     // ç§˜å¯†å¯†é’¥ï¼ˆé»˜è®¤ minioadminï¼‰
    private String bucketName;    // å­˜å‚¨æ¡¶åç§°: fitness-platform
}
```

**2. MinIOå®¢æˆ·ç«¯é…ç½®** (`common/config/MinioConfiguration.java`)ï¼š
```java
@Configuration
@EnableConfigurationProperties(MinioProperties.class)
public class MinioConfiguration {

    @Bean
    public MinioClient minioClient(MinioProperties properties) {
        return MinioClient.builder()
                .endpoint(properties.getEndpoint())
                .credentials(properties.getAccessKey(), properties.getSecretKey())
                .build();
    }
}
```

**3. MinIOå·¥å…·ç±»** (`common/util/MinioUtil.java`)ï¼š
```java
@Component
@RequiredArgsConstructor
@Slf4j
public class MinioUtil {

    private final MinioClient minioClient;
    private final MinioProperties minioProperties;

    /**
     * ä¸Šä¼ æ–‡ä»¶åˆ°MinIO
     * @param file æ–‡ä»¶å¯¹è±¡
     * @param folder å­˜å‚¨æ–‡ä»¶å¤¹ï¼ˆå¦‚ "store/images"ï¼‰
     * @return æ–‡ä»¶è®¿é—®URL
     */
    public String uploadFile(MultipartFile file, String folder) throws Exception {
        // 1. ç¡®ä¿Bucketå­˜åœ¨
        createBucketIfNotExists();

        // 2. ç”Ÿæˆå”¯ä¸€æ–‡ä»¶å: UUID_åŸå§‹æ–‡ä»¶å
        String originalFilename = file.getOriginalFilename();
        String extension = originalFilename.substring(originalFilename.lastIndexOf("."));
        String fileName = UUID.randomUUID() + extension;
        String objectName = folder + "/" + fileName;

        // 3. ä¸Šä¼ æ–‡ä»¶
        minioClient.putObject(
                PutObjectArgs.builder()
                        .bucket(minioProperties.getBucketName())
                        .object(objectName)
                        .stream(file.getInputStream(), file.getSize(), -1)
                        .contentType(file.getContentType())
                        .build()
        );

        // 4. è¿”å›è®¿é—®URL
        return minioProperties.getEndpoint() + "/" +
               minioProperties.getBucketName() + "/" +
               objectName;
    }

    /**
     * è‡ªåŠ¨åˆ›å»ºBucketå¹¶è®¾ç½®å…¬å¼€è¯»ç­–ç•¥
     */
    private void createBucketIfNotExists() throws Exception {
        String bucketName = minioProperties.getBucketName();

        // æ£€æŸ¥Bucketæ˜¯å¦å­˜åœ¨
        boolean exists = minioClient.bucketExists(
                BucketExistsArgs.builder().bucket(bucketName).build()
        );

        if (!exists) {
            // åˆ›å»ºBucket
            minioClient.makeBucket(
                    MakeBucketArgs.builder().bucket(bucketName).build()
            );
            log.info("MinIO Bucketåˆ›å»ºæˆåŠŸ: {}", bucketName);

            // è®¾ç½®å…¬å¼€è¯»ç­–ç•¥ï¼ˆå…è®¸åŒ¿åè®¿é—®ï¼‰
            String policy = """
            {
                "Version": "2012-10-17",
                "Statement": [{
                    "Effect": "Allow",
                    "Principal": {"AWS": ["*"]},
                    "Action": ["s3:GetObject"],
                    "Resource": ["arn:aws:s3:::%s/*"]
                }]
            }
            """.formatted(bucketName);

            minioClient.setBucketPolicy(
                    SetBucketPolicyArgs.builder()
                            .bucket(bucketName)
                            .config(policy)
                            .build()
            );
            log.info("MinIO Bucketç­–ç•¥è®¾ç½®æˆåŠŸ");
        }
    }

    /**
     * åˆ é™¤æ–‡ä»¶
     * @param fileUrl æ–‡ä»¶å®Œæ•´URL
     */
    public void deleteFile(String fileUrl) throws Exception {
        // ä»URLæå–å¯¹è±¡å
        String bucketName = minioProperties.getBucketName();
        int index = fileUrl.indexOf(bucketName) + bucketName.length() + 1;
        String objectName = fileUrl.substring(index);

        minioClient.removeObject(
                RemoveObjectArgs.builder()
                        .bucket(bucketName)
                        .object(objectName)
                        .build()
        );
        log.info("MinIOæ–‡ä»¶åˆ é™¤æˆåŠŸ: {}", objectName);
    }

    /**
     * æ‰¹é‡åˆ é™¤æ–‡ä»¶
     * @param fileUrls æ–‡ä»¶URLåˆ—è¡¨
     */
    public void deleteFiles(List<String> fileUrls) {
        fileUrls.forEach(url -> {
            try {
                deleteFile(url);
            } catch (Exception e) {
                log.error("æ–‡ä»¶åˆ é™¤å¤±è´¥: {}", url, e);
            }
        });
    }

    /**
     * è·å–æ–‡ä»¶ä¸‹è½½URLï¼ˆå¸¦è¿‡æœŸæ—¶é—´ï¼‰
     * @param objectName å¯¹è±¡åç§°
     * @param expirySeconds è¿‡æœŸæ—¶é—´ï¼ˆç§’ï¼‰
     * @return é¢„ç­¾åURL
     */
    public String getPresignedUrl(String objectName, int expirySeconds) throws Exception {
        return minioClient.getPresignedObjectUrl(
                GetPresignedObjectUrlArgs.builder()
                        .bucket(minioProperties.getBucketName())
                        .object(objectName)
                        .expiry(expirySeconds)
                        .build()
        );
    }
}
```

**4. application.ymlé…ç½®**ï¼š
```yaml
# MinIOå¯¹è±¡å­˜å‚¨é…ç½®
minio:
  endpoint: http://localhost:9000          # MinIOæœåŠ¡åœ°å€
  access-key: minioadmin                   # è®¿é—®å¯†é’¥
  secret-key: minioadmin                   # ç§˜å¯†å¯†é’¥
  bucket-name: fitness-platform            # å­˜å‚¨æ¡¶åç§°

# Springæ–‡ä»¶ä¸Šä¼ é…ç½®
spring:
  servlet:
    multipart:
      enabled: true                        # å¯ç”¨æ–‡ä»¶ä¸Šä¼ 
      max-file-size: 10MB                  # å•ä¸ªæ–‡ä»¶æœ€å¤§10MB
      max-request-size: 20MB               # æ•´ä¸ªè¯·æ±‚æœ€å¤§20MB
```

#### 3.3.4 MinIOéƒ¨ç½²æŒ‡å—

**æ–¹å¼1: Dockeréƒ¨ç½²ï¼ˆæ¨èï¼‰**ï¼š
```bash
# 1. æ‹‰å–é•œåƒ
docker pull minio/minio:latest

# 2. è¿è¡Œå®¹å™¨
docker run -d \
  -p 9000:9000 \
  -p 9001:9001 \
  --name minio-server \
  -e "MINIO_ROOT_USER=minioadmin" \
  -e "MINIO_ROOT_PASSWORD=minioadmin" \
  -v D:/minio-data:/data \
  minio/minio server /data --console-address ":9001"

# 3. éªŒè¯éƒ¨ç½²
curl http://localhost:9000/minio/health/live
# å“åº”: OK
```

**æ–¹å¼2: Windowså¯æ‰§è¡Œæ–‡ä»¶**ï¼š
```powershell
# 1. ä¸‹è½½MinIO Windowsç‰ˆæœ¬
# å®˜ç½‘: https://min.io/download#/windows

# 2. å¯åŠ¨æœåŠ¡
.\minio.exe server D:\minio-data --console-address ":9001"

# 3. è®¿é—®æ§åˆ¶å°
# http://localhost:9001
# ç™»å½•: minioadmin / minioadmin
```

**æ–¹å¼3: Linuxéƒ¨ç½²**ï¼š
```bash
# 1. ä¸‹è½½
wget https://dl.min.io/server/minio/release/linux-amd64/minio
chmod +x minio

# 2. å¯åŠ¨
./minio server /data --console-address ":9001"

# 3. åå°è¿è¡Œï¼ˆsystemdï¼‰
cat > /etc/systemd/system/minio.service <<EOF
[Unit]
Description=MinIO
After=network.target

[Service]
Type=simple
User=minio
ExecStart=/usr/local/bin/minio server /data --console-address ":9001"
Restart=always

[Install]
WantedBy=multi-user.target
EOF

systemctl enable minio
systemctl start minio
```

#### 3.3.5 é¡¹ç›®ä¸­çš„åº”ç”¨

**1. é—¨åº—å›¾ç‰‡ä¸Šä¼ ** (`GymStoreController.java`)ï¼š
```java
@RestController
@RequestMapping("/admin/gym-store")
@RequiredArgsConstructor
public class GymStoreController {

    private final MinioUtil minioUtil;

    @PostMapping("/upload-image")
    public Result<String> uploadImage(@RequestParam("file") MultipartFile file) {
        // 1. éªŒè¯æ–‡ä»¶
        if (file == null || file.isEmpty()) {
            return Result.fail("è¯·é€‰æ‹©è¦ä¸Šä¼ çš„å›¾ç‰‡");
        }

        // 2. éªŒè¯æ–‡ä»¶ç±»å‹
        String contentType = file.getContentType();
        if (contentType == null || !contentType.startsWith("image/")) {
            return Result.fail("åªæ”¯æŒä¸Šä¼ å›¾ç‰‡æ–‡ä»¶");
        }

        // 3. éªŒè¯æ–‡ä»¶å¤§å°ï¼ˆ10MBï¼‰
        if (file.getSize() > 10 * 1024 * 1024) {
            return Result.fail("å›¾ç‰‡å¤§å°ä¸èƒ½è¶…è¿‡10MB");
        }

        try {
            // 4. ä¸Šä¼ åˆ°MinIO
            String fileUrl = minioUtil.uploadFile(file, "store/images");
            log.info("å›¾ç‰‡ä¸Šä¼ æˆåŠŸ: {}", fileUrl);
            return Result.success(fileUrl);
        } catch (Exception e) {
            log.error("å›¾ç‰‡ä¸Šä¼ å¤±è´¥", e);
            return Result.fail("å›¾ç‰‡ä¸Šä¼ å¤±è´¥: " + e.getMessage());
        }
    }
}
```

**2. ç”¨æˆ·å¤´åƒä¸Šä¼ ** (`UserController.java`)ï¼š
```java
@PostMapping("/upload-avatar")
public Result<String> uploadAvatar(@RequestParam("file") MultipartFile file) {
    try {
        // ä¸Šä¼ åˆ° user/avatars æ–‡ä»¶å¤¹
        String avatarUrl = minioUtil.uploadFile(file, "user/avatars");

        // æ›´æ–°ç”¨æˆ·å¤´åƒå­—æ®µ
        Long userId = UserContext.getUserId();
        User user = new User();
        user.setId(userId);
        user.setAvatar(avatarUrl);
        userService.updateById(user);

        return Result.success(avatarUrl);
    } catch (Exception e) {
        return Result.fail("å¤´åƒä¸Šä¼ å¤±è´¥");
    }
}
```

**3. å¥åº·æ–‡ç« å°é¢å›¾** (`HealthArticleController.java`)ï¼š
```java
@PostMapping("/upload-cover")
public Result<String> uploadCover(@RequestParam("file") MultipartFile file) {
    try {
        String coverUrl = minioUtil.uploadFile(file, "article/covers");
        return Result.success(coverUrl);
    } catch (Exception e) {
        return Result.fail("å°é¢ä¸Šä¼ å¤±è´¥");
    }
}
```

**4. åˆ é™¤æ–‡ä»¶ç¤ºä¾‹**ï¼ˆæ›´æ–°é—¨åº—æ—¶åˆ é™¤æ—§å›¾ç‰‡ï¼‰ï¼š
```java
@Override
public void updateStore(GymStoreUpdateDTO updateDTO) {
    // 1. æŸ¥è¯¢æ—§æ•°æ®
    GymStore oldStore = this.getById(updateDTO.getId());

    // 2. å¯¹æ¯”å›¾ç‰‡åˆ—è¡¨ï¼Œåˆ é™¤æ—§å›¾ç‰‡
    List<String> oldImages = parseJsonArray(oldStore.getImages());
    List<String> newImages = updateDTO.getImages();

    List<String> deletedImages = oldImages.stream()
            .filter(img -> !newImages.contains(img))
            .collect(Collectors.toList());

    if (!deletedImages.isEmpty()) {
        minioUtil.deleteFiles(deletedImages);
    }

    // 3. æ›´æ–°é—¨åº—ä¿¡æ¯
    GymStore gymStore = BeanUtil.copyProperties(updateDTO, GymStore.class);
    this.updateById(gymStore);
}
```

#### 3.3.6 å®ç°åŠŸèƒ½æ¸…å•

| åŠŸèƒ½æ¨¡å— | å­˜å‚¨è·¯å¾„ | æ–‡ä»¶ç±»å‹ | å¤§å°é™åˆ¶ | è®¿é—®æƒé™ |
|---------|---------|---------|---------|---------|
| é—¨åº—å›¾ç‰‡ | `store/images/` | jpg/png/jpeg | 10MB | å…¬å¼€è¯» |
| ç”¨æˆ·å¤´åƒ | `user/avatars/` | jpg/png | 5MB | å…¬å¼€è¯» |
| æ–‡ç« å°é¢ | `article/covers/` | jpg/png | 5MB | å…¬å¼€è¯» |
| è¯¾ç¨‹è§†é¢‘ | `course/videos/` | mp4/avi | 500MB | é¢„ç­¾åURL |
| ä½“æµ‹æŠ¥å‘Š | `health/reports/` | pdf | 20MB | é¢„ç­¾åURL |
| æ•™ç»ƒè¯ä¹¦ | `coach/certificates/` | jpg/pdf | 10MB | ç§æœ‰ |

**ç›®å½•ç»“æ„ç¤ºä¾‹**ï¼š
```
fitness-platform (Bucket)
â”œâ”€â”€ store/
â”‚   â”œâ”€â”€ images/
â”‚   â”‚   â”œâ”€â”€ uuid1_store1.jpg
â”‚   â”‚   â””â”€â”€ uuid2_store2.jpg
â”‚   â””â”€â”€ documents/
â”‚       â””â”€â”€ business_license.pdf
â”œâ”€â”€ user/
â”‚   â”œâ”€â”€ avatars/
â”‚   â”‚   â””â”€â”€ uuid_avatar.jpg
â”‚   â””â”€â”€ id_cards/
â”‚       â””â”€â”€ uuid_idcard.jpg
â”œâ”€â”€ article/
â”‚   â”œâ”€â”€ covers/
â”‚   â””â”€â”€ images/
â”œâ”€â”€ course/
â”‚   â””â”€â”€ videos/
â””â”€â”€ health/
    â””â”€â”€ reports/
```

---

## å››ã€å¤–éƒ¨APIæœåŠ¡é›†æˆ

### 4.1 é«˜å¾·åœ°å›¾API

#### 4.1.1 åŠŸèƒ½æ¦‚è¿°

**é›†æˆç›®çš„**ï¼š
- âœ… åœ°å€è½¬åæ ‡ï¼ˆåœ°ç†ç¼–ç ï¼‰
- âœ… åæ ‡è½¬åœ°å€ï¼ˆé€†åœ°ç†ç¼–ç ï¼‰
- âœ… å®é™…è·¯å¾„è·ç¦»è®¡ç®—ï¼ˆé©¾è½¦/æ­¥è¡Œï¼‰
- âœ… è·¯å¾„è§„åˆ’å¯¼èˆª
- âœ… å‘¨è¾¹POIæŸ¥è¯¢

**ä¸Haversineå…¬å¼çš„å…³ç³»**ï¼š
- Haversineï¼šè®¡ç®—**ç›´çº¿è·ç¦»**ï¼ˆå·²åœ¨é¡¹ç›®ä¸­å®ç°ï¼‰
- é«˜å¾·APIï¼šè®¡ç®—**å®é™…è·¯å¾„è·ç¦»**ï¼ˆé“è·¯è·ç¦»ï¼‰

#### 4.1.2 ç”³è¯·æ­¥éª¤

**ç¬¬1æ­¥ï¼šæ³¨å†Œå¼€å‘è€…è´¦å·**
1. è®¿é—®ï¼šhttps://lbs.amap.com/
2. ç‚¹å‡»å³ä¸Šè§’"æ³¨å†Œ/ç™»å½•" â†’ æ‰‹æœºå·æ³¨å†Œ
3. å®Œæˆå®åè®¤è¯ï¼ˆä¸ªäºº/ä¼ä¸šï¼‰

**ç¬¬2æ­¥ï¼šåˆ›å»ºåº”ç”¨**
1. ç™»å½•æ§åˆ¶å°ï¼šhttps://console.amap.com/dev/key/app
2. ç‚¹å‡»"åˆ›å»ºæ–°åº”ç”¨"
   - åº”ç”¨åç§°ï¼š`å¥èº«å¹³å°`
   - åº”ç”¨ç±»å‹ï¼š`WebæœåŠ¡`
3. ç‚¹å‡»"æ·»åŠ Key"
   - Keyåç§°ï¼š`åç«¯APIå¯†é’¥`
   - æœåŠ¡å¹³å°ï¼š`WebæœåŠ¡`
   - ç™½åå•IPï¼šç•™ç©ºï¼ˆå¼€å‘ç¯å¢ƒï¼‰ï¼Œç”Ÿäº§å¡«æœåŠ¡å™¨IP

**ç¬¬3æ­¥ï¼šè·å–API Key**
```
ç¤ºä¾‹Key: a1b2c3d4e5f6g7h8i9j0k1l2m3n4o5p6
```

**å…è´¹é¢åº¦**ï¼ˆä¸ªäººå¼€å‘è€…ï¼‰ï¼š
- åœ°ç†ç¼–ç /é€†åœ°ç†ç¼–ç ï¼š**30ä¸‡æ¬¡/æ—¥**
- è·¯å¾„è§„åˆ’ï¼š**10ä¸‡æ¬¡/æ—¥**
- è·ç¦»æµ‹é‡ï¼š**10ä¸‡æ¬¡/æ—¥**

#### 4.1.3 ä¾èµ–é…ç½®

**Mavenä¾èµ–**ï¼ˆHTTPå®¢æˆ·ç«¯ï¼‰ï¼š
```xml
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-web</artifactId>
    <!-- åŒ…å«RestTemplate -->
</dependency>

<!-- æˆ–ä½¿ç”¨OkHttp -->
<dependency>
    <groupId>com.squareup.okhttp3</groupId>
    <artifactId>okhttp</artifactId>
    <version>4.11.0</version>
</dependency>
```

**application.ymlé…ç½®**ï¼š
```yaml
# é«˜å¾·åœ°å›¾APIé…ç½®
amap:
  api-key: YOUR_AMAP_API_KEY                    # æ›¿æ¢ä¸ºå®é™…Key
  web-service-url: https://restapi.amap.com     # APIåŸºç¡€URL

  # APIç«¯ç‚¹
  geocode-url: /v3/geocode/geo                  # åœ°ç†ç¼–ç 
  regeocode-url: /v3/geocode/regeo              # é€†åœ°ç†ç¼–ç 
  distance-url: /v3/distance                    # è·ç¦»æµ‹é‡
  direction-walking-url: /v3/direction/walking  # æ­¥è¡Œè·¯å¾„
  direction-driving-url: /v3/direction/driving  # é©¾è½¦è·¯å¾„
```

#### 4.1.4 é›†æˆå®ç°

**1. é…ç½®å±æ€§ç±»** (`common/config/AmapProperties.java`)ï¼š
```java
@Data
@Configuration
@ConfigurationProperties(prefix = "amap")
public class AmapProperties {
    private String apiKey;
    private String webServiceUrl;
    private String geocodeUrl;
    private String regeocodeUrl;
    private String distanceUrl;
    private String directionWalkingUrl;
    private String directionDrivingUrl;
}
```

**2. é«˜å¾·åœ°å›¾æœåŠ¡ç±»** (`common/service/AmapService.java`)ï¼š
```java
@Service
@RequiredArgsConstructor
@Slf4j
public class AmapService {

    private final AmapProperties amapProperties;
    private final RestTemplate restTemplate = new RestTemplate();

    /**
     * åœ°ç†ç¼–ç ï¼šåœ°å€è½¬åæ ‡
     * @param address è¯¦ç»†åœ°å€
     * @param city åŸå¸‚åç§°ï¼ˆå¯é€‰ï¼Œæé«˜å‡†ç¡®åº¦ï¼‰
     * @return {latitude: 39.996893, longitude: 116.481488}
     */
    public Map<String, Double> getLocationByAddress(String address, String city) {
        try {
            String url = amapProperties.getWebServiceUrl() +
                        amapProperties.getGeocodeUrl() +
                        "?key=" + amapProperties.getApiKey() +
                        "&address=" + URLEncoder.encode(address, StandardCharsets.UTF_8);

            if (StringUtils.hasText(city)) {
                url += "&city=" + URLEncoder.encode(city, StandardCharsets.UTF_8);
            }

            // è°ƒç”¨é«˜å¾·API
            String response = restTemplate.getForObject(url, String.class);
            JSONObject json = JSONObject.parseObject(response);

            // è§£æå“åº”
            if ("1".equals(json.getString("status")) && json.getInteger("count") > 0) {
                String location = json.getJSONArray("geocodes")
                                     .getJSONObject(0)
                                     .getString("location");
                String[] coords = location.split(",");

                return Map.of(
                    "longitude", Double.parseDouble(coords[0]),
                    "latitude", Double.parseDouble(coords[1])
                );
            } else {
                throw new BusinessException("åœ°ç†ç¼–ç å¤±è´¥: " + json.getString("info"));
            }
        } catch (Exception e) {
            log.error("åœ°ç†ç¼–ç å¼‚å¸¸: address={}, city={}", address, city, e);
            throw new BusinessException("åœ°ç†ç¼–ç æœåŠ¡å¼‚å¸¸");
        }
    }

    /**
     * é€†åœ°ç†ç¼–ç ï¼šåæ ‡è½¬åœ°å€
     * @param longitude ç»åº¦
     * @param latitude çº¬åº¦
     * @return æ ¼å¼åŒ–åœ°å€
     */
    public String getAddressByLocation(Double longitude, Double latitude) {
        try {
            String url = amapProperties.getWebServiceUrl() +
                        amapProperties.getRegeocodeUrl() +
                        "?key=" + amapProperties.getApiKey() +
                        "&location=" + longitude + "," + latitude;

            String response = restTemplate.getForObject(url, String.class);
            JSONObject json = JSONObject.parseObject(response);

            if ("1".equals(json.getString("status"))) {
                return json.getJSONObject("regeocode")
                          .getString("formatted_address");
            } else {
                throw new BusinessException("é€†åœ°ç†ç¼–ç å¤±è´¥");
            }
        } catch (Exception e) {
            log.error("é€†åœ°ç†ç¼–ç å¼‚å¸¸: lon={}, lat={}", longitude, latitude, e);
            throw new BusinessException("é€†åœ°ç†ç¼–ç æœåŠ¡å¼‚å¸¸");
        }
    }

    /**
     * è·ç¦»æµ‹é‡ï¼šè®¡ç®—å®é™…è·¯å¾„è·ç¦»
     * @param originLon èµ·ç‚¹ç»åº¦
     * @param originLat èµ·ç‚¹çº¬åº¦
     * @param destLon ç»ˆç‚¹ç»åº¦
     * @param destLat ç»ˆç‚¹çº¬åº¦
     * @param type 1=é©¾è½¦è·ç¦», 0=ç›´çº¿è·ç¦»
     * @return {distance: 12.58(å…¬é‡Œ), duration: 22(åˆ†é’Ÿ)}
     */
    public Map<String, Object> calculateDistance(
            Double originLon, Double originLat,
            Double destLon, Double destLat,
            Integer type) {
        try {
            String url = amapProperties.getWebServiceUrl() +
                        amapProperties.getDistanceUrl() +
                        "?key=" + amapProperties.getApiKey() +
                        "&origins=" + originLon + "," + originLat +
                        "&destination=" + destLon + "," + destLat +
                        "&type=" + type;

            String response = restTemplate.getForObject(url, String.class);
            JSONObject json = JSONObject.parseObject(response);

            if ("1".equals(json.getString("status"))) {
                JSONObject result = json.getJSONArray("results").getJSONObject(0);

                return Map.of(
                    "distance", result.getDouble("distance") / 1000,  // ç±³è½¬å…¬é‡Œ
                    "duration", result.getInteger("duration") / 60    // ç§’è½¬åˆ†é’Ÿ
                );
            } else {
                throw new BusinessException("è·ç¦»æµ‹é‡å¤±è´¥");
            }
        } catch (Exception e) {
            log.error("è·ç¦»æµ‹é‡å¼‚å¸¸", e);
            throw new BusinessException("è·ç¦»æµ‹é‡æœåŠ¡å¼‚å¸¸");
        }
    }

    /**
     * è·¯å¾„è§„åˆ’ï¼šè·å–å¯¼èˆªè·¯çº¿
     * @param originLon èµ·ç‚¹ç»åº¦
     * @param originLat èµ·ç‚¹çº¬åº¦
     * @param destLon ç»ˆç‚¹ç»åº¦
     * @param destLat ç»ˆç‚¹çº¬åº¦
     * @param type 1=æ­¥è¡Œ, 2=é©¾è½¦
     * @return è·¯å¾„è¯¦æƒ…
     */
    public Map<String, Object> getRoute(
            Double originLon, Double originLat,
            Double destLon, Double destLat,
            Integer type) {
        try {
            String apiUrl = type == 1 ?
                    amapProperties.getDirectionWalkingUrl() :
                    amapProperties.getDirectionDrivingUrl();

            String url = amapProperties.getWebServiceUrl() + apiUrl +
                        "?key=" + amapProperties.getApiKey() +
                        "&origin=" + originLon + "," + originLat +
                        "&destination=" + destLon + "," + destLat;

            String response = restTemplate.getForObject(url, String.class);
            JSONObject json = JSONObject.parseObject(response);

            if ("1".equals(json.getString("status"))) {
                JSONObject route = json.getJSONObject("route");
                JSONObject path = route.getJSONArray("paths").getJSONObject(0);

                return Map.of(
                    "distance", path.getDouble("distance") / 1000,
                    "duration", path.getInteger("duration") / 60,
                    "steps", path.getJSONArray("steps")  // å¯¼èˆªæ­¥éª¤
                );
            } else {
                throw new BusinessException("è·¯å¾„è§„åˆ’å¤±è´¥");
            }
        } catch (Exception e) {
            log.error("è·¯å¾„è§„åˆ’å¼‚å¸¸", e);
            throw new BusinessException("è·¯å¾„è§„åˆ’æœåŠ¡å¼‚å¸¸");
        }
    }
}
```

**3. Controllerä¸­ä½¿ç”¨**ï¼š

**æ–°å¢é—¨åº—æ—¶è‡ªåŠ¨è·å–åæ ‡**ï¼š
```java
@RestController
@RequestMapping("/admin/gym-store")
@RequiredArgsConstructor
public class GymStoreController {

    private final AmapService amapService;

    // æ–°å¢æ¥å£ï¼šåœ°å€è½¬åæ ‡
    @GetMapping("/geocode")
    public Result<Map<String, Double>> geocode(
            @RequestParam String address,
            @RequestParam(required = false) String city) {
        Map<String, Double> location = amapService.getLocationByAddress(address, city);
        return Result.success(location);
    }
}
```

**å‰ç«¯ä½¿ç”¨**ï¼ˆAdminç«¯æ–°å¢é—¨åº—ï¼‰ï¼š
```javascript
// ç”¨æˆ·è¾“å…¥åœ°å€åï¼Œè‡ªåŠ¨è°ƒç”¨æ¥å£è·å–åæ ‡
async function onAddressChange(address, city) {
  try {
    const response = await axios.get('/admin/gym-store/geocode', {
      params: { address, city }
    });

    // è‡ªåŠ¨å¡«å……ç»çº¬åº¦
    formData.latitude = response.data.data.latitude;
    formData.longitude = response.data.data.longitude;
  } catch (error) {
    console.error('åœ°ç†ç¼–ç å¤±è´¥', error);
  }
}
```

**Appç«¯é—¨åº—è¯¦æƒ…æ˜¾ç¤ºå®é™…è·ç¦»**ï¼š
```java
@GetMapping("/{id}")
public Result<GymStoreDetailVO> detail(
        @PathVariable Long id,
        @RequestParam(required = false) Double userLatitude,
        @RequestParam(required = false) Double userLongitude,
        @RequestParam(defaultValue = "0") Integer distanceType) {  // 0=ç›´çº¿, 1=é©¾è½¦

    GymStoreDetailVO detailVO = appGymStoreService.getStoreDetail(id, userLatitude, userLongitude);

    // å¦‚æœéœ€è¦å®é™…è·¯å¾„è·ç¦»
    if (distanceType == 1 && userLatitude != null && userLongitude != null) {
        Map<String, Object> realDistance = amapService.calculateDistance(
            userLongitude, userLatitude,
            detailVO.getLongitude(), detailVO.getLatitude(),
            1  // é©¾è½¦è·ç¦»
        );
        detailVO.setDistance((Double) realDistance.get("distance"));
        detailVO.setDuration((Integer) realDistance.get("duration"));
    }

    return Result.success(detailVO);
}
```

#### 4.1.5 å‰ç«¯åœ°å›¾å±•ç¤º

**å¼•å…¥é«˜å¾·åœ°å›¾JS API**ï¼ˆVue 3ï¼‰ï¼š
```html
<!-- public/index.html -->
<script src="https://webapi.amap.com/maps?v=2.0&key=YOUR_WEB_KEY"></script>
```

**åœ°å›¾ç»„ä»¶**ï¼š
```vue
<template>
  <div id="map-container" style="width:100%;height:400px;"></div>
</template>

<script setup>
import { onMounted } from 'vue';

const props = defineProps({
  stores: Array,  // é—¨åº—åˆ—è¡¨
  userLocation: Object  // ç”¨æˆ·ä½ç½® {lat, lng}
});

onMounted(() => {
  // åˆå§‹åŒ–åœ°å›¾
  const map = new AMap.Map('map-container', {
    center: [props.userLocation.lng, props.userLocation.lat],
    zoom: 12
  });

  // æ·»åŠ ç”¨æˆ·ä½ç½®æ ‡è®°
  new AMap.Marker({
    position: [props.userLocation.lng, props.userLocation.lat],
    icon: '//a.amap.com/jsapi_demos/static/demo-center/icons/poi-marker-default.png',
    title: 'æˆ‘çš„ä½ç½®'
  }).setMap(map);

  // æ·»åŠ é—¨åº—æ ‡è®°
  props.stores.forEach(store => {
    const marker = new AMap.Marker({
      position: [store.longitude, store.latitude],
      title: store.storeName
    });

    // ç‚¹å‡»æ ‡è®°æ˜¾ç¤ºè¯¦æƒ…
    marker.on('click', () => {
      const infoWindow = new AMap.InfoWindow({
        content: `
          <div style="padding:10px;">
            <h3>${store.storeName}</h3>
            <p>${store.address}</p>
            <p>è·ç¦»: ${store.distance}å…¬é‡Œ</p>
            <button onclick="viewDetail(${store.id})">æŸ¥çœ‹è¯¦æƒ…</button>
          </div>
        `
      });
      infoWindow.open(map, marker.getPosition());
    });

    map.add(marker);
  });
});
</script>
```

**å”¤èµ·é«˜å¾·åœ°å›¾APPå¯¼èˆª**ï¼š
```javascript
function navigateToStore(storeLat, storeLon, storeName) {
  // iOS
  if (/(iPhone|iPad|iPod)/i.test(navigator.userAgent)) {
    window.location.href = `iosamap://path?sourceApplication=å¥èº«å¹³å°&dlat=${storeLat}&dlon=${storeLon}&dname=${storeName}&dev=0&t=0`;
  }
  // Android
  else if (/Android/i.test(navigator.userAgent)) {
    window.location.href = `androidamap://route?sourceApplication=å¥èº«å¹³å°&dlat=${storeLat}&dlon=${storeLon}&dname=${storeName}&dev=0&t=0`;
  }
  // Webç«¯ï¼ˆæ‰“å¼€é«˜å¾·åœ°å›¾ç½‘é¡µç‰ˆï¼‰
  else {
    window.open(`https://uri.amap.com/navigation?to=${storeLon},${storeLat},${storeName}&mode=walk&src=å¥èº«å¹³å°`);
  }
}
```

#### 4.1.6 å®ç°åŠŸèƒ½æ¸…å•

| åŠŸèƒ½ | APIç«¯ç‚¹ | é¡¹ç›®å®ç°ä½ç½® | çŠ¶æ€ |
|------|--------|-------------|------|
| åœ°å€è½¬åæ ‡ | `/v3/geocode/geo` | `AmapService.getLocationByAddress()` | ğŸ”§ å¾…é›†æˆ |
| åæ ‡è½¬åœ°å€ | `/v3/geocode/regeo` | `AmapService.getAddressByLocation()` | ğŸ”§ å¾…é›†æˆ |
| è·ç¦»æµ‹é‡ | `/v3/distance` | `AmapService.calculateDistance()` | ğŸ”§ å¾…é›†æˆ |
| è·¯å¾„è§„åˆ’ | `/v3/direction/walking` | `AmapService.getRoute()` | ğŸ”§ å¾…é›†æˆ |
| å‰ç«¯åœ°å›¾å±•ç¤º | JS API 2.0 | Vueç»„ä»¶ | ğŸ”§ å¾…é›†æˆ |
| ç›´çº¿è·ç¦»è®¡ç®— | - | Haversineå…¬å¼ | âœ… å·²å®ç° |

---

### 4.2 çŸ­ä¿¡éªŒè¯ç æœåŠ¡

#### 4.2.1 åŠŸèƒ½æ¦‚è¿°

**é›†æˆç›®çš„**ï¼š
- âœ… ç”¨æˆ·æ³¨å†ŒéªŒè¯
- âœ… ç™»å½•éªŒè¯ç 
- âœ… æ‰¾å›å¯†ç éªŒè¯
- âœ… ä¿®æ”¹æ‰‹æœºå·éªŒè¯
- âœ… æ•æ„Ÿæ“ä½œäºŒæ¬¡éªŒè¯

**æ¨èæœåŠ¡å•†å¯¹æ¯”**ï¼š

| æœåŠ¡å•† | ä»·æ ¼ | å…è´¹é¢åº¦ | åˆ°è¾¾ç‡ | éªŒè¯ç æœ‰æ•ˆæœŸ | æ¨èåº¦ |
|--------|------|---------|-------|-------------|--------|
| é˜¿é‡Œäº‘SMS | 0.045å…ƒ/æ¡ | é¦–æœˆ100æ¡ | 99%+ | 5åˆ†é’Ÿ | â­â­â­â­â­ |
| è…¾è®¯äº‘SMS | 0.045å…ƒ/æ¡ | é¦–æœˆ100æ¡ | 99%+ | 5åˆ†é’Ÿ | â­â­â­â­â­ |
| ç½‘æ˜“äº‘ä¿¡ | 0.05å…ƒ/æ¡ | ä½“éªŒç‰ˆ100æ¡/æœˆ | 98%+ | 5åˆ†é’Ÿ | â­â­â­â­ |
| å®¹è”äº‘ | 0.04å…ƒ/æ¡ | ä½“éªŒç‰ˆ50æ¡ | 98%+ | 5åˆ†é’Ÿ | â­â­â­ |

#### 4.2.2 é˜¿é‡Œäº‘SMSé›†æˆæ–¹æ¡ˆ

**ç¬¬1æ­¥ï¼šå¼€é€šæœåŠ¡**
1. ç™»å½•é˜¿é‡Œäº‘æ§åˆ¶å°ï¼šhttps://dysms.console.aliyun.com/
2. å¼€é€šçŸ­ä¿¡æœåŠ¡
3. åˆ›å»ºç­¾åï¼ˆå¦‚"å¥èº«å¹³å°"ï¼‰
4. åˆ›å»ºæ¨¡æ¿ï¼ˆå¦‚"æ‚¨çš„éªŒè¯ç ä¸º${code}ï¼Œ5åˆ†é’Ÿå†…æœ‰æ•ˆ"ï¼‰

**ç¬¬2æ­¥ï¼šè·å–å‡­è¯**
- AccessKey IDï¼š`LTAI5tXXXXXXXXXXXXXX`
- AccessKey Secretï¼š`xxxxxxxxxxxxxxxxxxxxxxxXXXXXX`
- ç­¾ååç§°ï¼š`å¥èº«å¹³å°`
- æ¨¡æ¿CODEï¼š`SMS_123456789`

**ä¾èµ–é…ç½®**ï¼š
```xml
<dependency>
    <groupId>com.aliyun</groupId>
    <artifactId>dysmsapi20170525</artifactId>
    <version>2.0.24</version>
</dependency>
```

**é…ç½®æ–‡ä»¶**ï¼š
```yaml
# é˜¿é‡Œäº‘çŸ­ä¿¡é…ç½®
aliyun:
  sms:
    access-key-id: LTAI5tXXXXXXXXXXXXXX
    access-key-secret: xxxxxxxxxxxxxxxxxxxxxxxXXXXXX
    sign-name: å¥èº«å¹³å°
    template-code: SMS_123456789
    region-id: cn-hangzhou
```

**é›†æˆå®ç°**ï¼š

**1. é…ç½®å±æ€§ç±»** (`common/config/AliyunSmsProperties.java`)ï¼š
```java
@Data
@Configuration
@ConfigurationProperties(prefix = "aliyun.sms")
public class AliyunSmsProperties {
    private String accessKeyId;
    private String accessKeySecret;
    private String signName;
    private String templateCode;
    private String regionId;
}
```

**2. çŸ­ä¿¡æœåŠ¡ç±»** (`common/service/SmsService.java`)ï¼š
```java
@Service
@RequiredArgsConstructor
@Slf4j
public class SmsService {

    private final AliyunSmsProperties smsProperties;
    private final RedisTemplate<String, String> redisTemplate;

    /**
     * å‘é€éªŒè¯ç 
     * @param phone æ‰‹æœºå·
     * @return éªŒè¯ç ï¼ˆå¼€å‘ç¯å¢ƒè¿”å›ï¼Œç”Ÿäº§ç¯å¢ƒä¸è¿”å›ï¼‰
     */
    public String sendVerificationCode(String phone) {
        // 1. éªŒè¯æ‰‹æœºå·æ ¼å¼
        if (!phone.matches("^1[3-9]\\d{9}$")) {
            throw new BusinessException("æ‰‹æœºå·æ ¼å¼ä¸æ­£ç¡®");
        }

        // 2. é™æµæ£€æŸ¥ï¼ˆåŒä¸€æ‰‹æœºå·1åˆ†é’Ÿå†…åªèƒ½å‘é€1æ¬¡ï¼‰
        String rateLimitKey = "sms:rate_limit:" + phone;
        if (Boolean.TRUE.equals(redisTemplate.hasKey(rateLimitKey))) {
            throw new BusinessException("å‘é€è¿‡äºé¢‘ç¹ï¼Œè¯·ç¨åå†è¯•");
        }

        // 3. ç”Ÿæˆ6ä½éšæœºéªŒè¯ç 
        String code = String.format("%06d", new Random().nextInt(999999));

        // 4. å­˜å…¥Redisï¼ˆ5åˆ†é’Ÿæœ‰æ•ˆæœŸï¼‰
        String codeKey = "sms:code:" + phone;
        redisTemplate.opsForValue().set(codeKey, code, 5, TimeUnit.MINUTES);

        // 5. è®¾ç½®é™æµï¼ˆ1åˆ†é’Ÿï¼‰
        redisTemplate.opsForValue().set(rateLimitKey, "1", 1, TimeUnit.MINUTES);

        // 6. è°ƒç”¨é˜¿é‡Œäº‘SDKå‘é€çŸ­ä¿¡
        boolean success = sendSmsToAliyun(phone, code);
        if (!success) {
            throw new BusinessException("çŸ­ä¿¡å‘é€å¤±è´¥");
        }

        log.info("éªŒè¯ç å‘é€æˆåŠŸ: phone={}, code={}", phone, code);

        // å¼€å‘ç¯å¢ƒè¿”å›éªŒè¯ç ï¼ˆæ–¹ä¾¿æµ‹è¯•ï¼‰
        return code;
    }

    /**
     * éªŒè¯éªŒè¯ç 
     * @param phone æ‰‹æœºå·
     * @param code éªŒè¯ç 
     * @return æ˜¯å¦éªŒè¯æˆåŠŸ
     */
    public boolean verifyCode(String phone, String code) {
        String codeKey = "sms:code:" + phone;
        String storedCode = redisTemplate.opsForValue().get(codeKey);

        if (code.equals(storedCode)) {
            // éªŒè¯æˆåŠŸååˆ é™¤éªŒè¯ç ï¼ˆé˜²æ­¢é‡å¤ä½¿ç”¨ï¼‰
            redisTemplate.delete(codeKey);
            return true;
        }
        return false;
    }

    /**
     * è°ƒç”¨é˜¿é‡Œäº‘SDKå‘é€çŸ­ä¿¡
     */
    private boolean sendSmsToAliyun(String phone, String code) {
        try {
            // åˆ›å»ºå®¢æˆ·ç«¯
            Config config = new Config()
                    .setAccessKeyId(smsProperties.getAccessKeyId())
                    .setAccessKeySecret(smsProperties.getAccessKeySecret())
                    .setRegionId(smsProperties.getRegionId());

            Client client = new Client(config);

            // æ„å»ºè¯·æ±‚
            SendSmsRequest request = new SendSmsRequest()
                    .setPhoneNumbers(phone)
                    .setSignName(smsProperties.getSignName())
                    .setTemplateCode(smsProperties.getTemplateCode())
                    .setTemplateParam("{\"code\":\"" + code + "\"}");

            // å‘é€è¯·æ±‚
            SendSmsResponse response = client.sendSms(request);

            // æ£€æŸ¥å“åº”
            return "OK".equals(response.getBody().getCode());
        } catch (Exception e) {
            log.error("é˜¿é‡Œäº‘çŸ­ä¿¡å‘é€å¼‚å¸¸: phone={}", phone, e);
            return false;
        }
    }
}
```

**3. Controllerä¸­ä½¿ç”¨**ï¼š
```java
@RestController
@RequestMapping("/app/auth")
@RequiredArgsConstructor
public class AuthController {

    private final SmsService smsService;

    @PostMapping("/send-code")
    @RateLimit(maxCount = 5, time = 1, timeUnit = TimeUnit.MINUTES)  // é™æµ
    public Result<Void> sendCode(@RequestParam String phone) {
        smsService.sendVerificationCode(phone);
        return Result.success();
    }

    @PostMapping("/login")
    public Result<LoginVO> login(@Valid @RequestBody LoginDTO loginDTO) {
        // éªŒè¯éªŒè¯ç 
        boolean valid = smsService.verifyCode(loginDTO.getPhone(), loginDTO.getCode());
        if (!valid) {
            return Result.fail("éªŒè¯ç é”™è¯¯æˆ–å·²è¿‡æœŸ");
        }

        // ç™»å½•é€»è¾‘...
        return Result.success(loginVO);
    }
}
```

#### 4.2.3 å¼€å‘ç¯å¢ƒMockæ–¹æ¡ˆ

**é…ç½®å¼€å…³**ï¼š
```yaml
# å¼€å‘ç¯å¢ƒé…ç½®
sms:
  mock-enabled: true  # å¯ç”¨Mockï¼Œä¸å®é™…å‘é€çŸ­ä¿¡
  mock-code: "123456" # å›ºå®šéªŒè¯ç 
```

**Mockå®ç°**ï¼š
```java
@Service
@RequiredArgsConstructor
@Slf4j
public class SmsService {

    @Value("${sms.mock-enabled:false}")
    private boolean mockEnabled;

    @Value("${sms.mock-code:123456}")
    private String mockCode;

    public String sendVerificationCode(String phone) {
        // Mockæ¨¡å¼ç›´æ¥è¿”å›å›ºå®šéªŒè¯ç 
        if (mockEnabled) {
            String codeKey = "sms:code:" + phone;
            redisTemplate.opsForValue().set(codeKey, mockCode, 5, TimeUnit.MINUTES);
            log.info("[Mock] éªŒè¯ç : {}", mockCode);
            return mockCode;
        }

        // ç”Ÿäº§ç¯å¢ƒæ­£å¸¸å‘é€
        // ...
    }
}
```

#### 4.2.4 å®ç°åŠŸèƒ½æ¸…å•

| åŠŸèƒ½ | æ¥å£è·¯å¾„ | çŠ¶æ€ | è¯´æ˜ |
|------|---------|------|------|
| å‘é€æ³¨å†ŒéªŒè¯ç  | `POST /app/auth/send-code` | ğŸ”§ å¾…é›†æˆ | 1åˆ†é’Ÿé™æµ |
| å‘é€ç™»å½•éªŒè¯ç  | `POST /app/auth/send-code` | ğŸ”§ å¾…é›†æˆ | å¤ç”¨åŒä¸€æ¥å£ |
| éªŒè¯ç æ ¡éªŒ | å†…éƒ¨æ–¹æ³• | ğŸ”§ å¾…é›†æˆ | Rediså­˜å‚¨ |
| Mockæ¨¡å¼ | é…ç½®å¼€å…³ | ğŸ”§ å¾…é›†æˆ | å¼€å‘ç¯å¢ƒä½¿ç”¨ |

---

### 4.3 æ”¯ä»˜æœåŠ¡é›†æˆ

#### 4.3.1 åŠŸèƒ½æ¦‚è¿°

**é›†æˆç›®çš„**ï¼š
- âœ… è¯¾ç¨‹è´­ä¹°æ”¯ä»˜
- âœ… ä¼šå‘˜å¡å……å€¼
- âœ… ç§æ•™æœåŠ¡æ”¯ä»˜
- âœ… è®¢å•é€€æ¬¾

**æ¨èæ”¯ä»˜æ–¹å¼**ï¼š

| æ”¯ä»˜æ–¹å¼ | è´¹ç‡ | ç»“ç®—å‘¨æœŸ | é€‚ç”¨åœºæ™¯ | æ¨èåº¦ |
|---------|------|---------|---------|--------|
| å¾®ä¿¡æ”¯ä»˜ | 0.6% | T+1 | ç§»åŠ¨ç«¯/å°ç¨‹åº | â­â­â­â­â­ |
| æ”¯ä»˜å® | 0.6% | T+1 | Webç«¯/ç§»åŠ¨ç«¯ | â­â­â­â­â­ |
| é“¶è”æ”¯ä»˜ | 0.5% | T+1 | PCç«¯ | â­â­â­ |
| PayPal | 3.4%+$0.3 | T+3 | å›½é™…æ”¯ä»˜ | â­â­ |

#### 4.3.2 å¾®ä¿¡æ”¯ä»˜é›†æˆæ–¹æ¡ˆï¼ˆV3ç‰ˆæœ¬ï¼‰

**ç¬¬1æ­¥ï¼šç”³è¯·èµ„è´¨**
1. æ³¨å†Œå¾®ä¿¡å•†æˆ·å¹³å°ï¼šhttps://pay.weixin.qq.com/
2. æäº¤èµ„è´¨è®¤è¯ï¼ˆè¥ä¸šæ‰§ç…§ã€æ³•äººèº«ä»½è¯ç­‰ï¼‰
3. ç­¾ç½²åè®®ï¼Œå¼€é€šæ”¯ä»˜åŠŸèƒ½

**ç¬¬2æ­¥ï¼šè·å–å‡­è¯**
- å•†æˆ·å·ï¼ˆmchIdï¼‰ï¼š`1234567890`
- APIå¯†é’¥ï¼ˆapiV3Keyï¼‰ï¼š`xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx`
- å•†æˆ·è¯ä¹¦åºåˆ—å·ï¼š`ABCDEF1234567890`
- APIv3ç§é’¥æ–‡ä»¶ï¼š`apiclient_key.pem`

**ä¾èµ–é…ç½®**ï¼š
```xml
<dependency>
    <groupId>com.github.wechatpay-apiv3</groupId>
    <artifactId>wechatpay-java</artifactId>
    <version>0.2.12</version>
</dependency>
```

**é…ç½®æ–‡ä»¶**ï¼š
```yaml
# å¾®ä¿¡æ”¯ä»˜é…ç½®
wechat:
  pay:
    app-id: wx1234567890abcdef                    # å…¬ä¼—å·/å°ç¨‹åºAppID
    mch-id: 1234567890                            # å•†æˆ·å·
    api-v3-key: xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx  # APIv3å¯†é’¥
    merchant-serial-number: ABCDEF1234567890      # è¯ä¹¦åºåˆ—å·
    private-key-path: classpath:cert/apiclient_key.pem  # ç§é’¥è·¯å¾„
    notify-url: https://yourdomain.com/api/payment/notify  # æ”¯ä»˜å›è°ƒURL
```

**é›†æˆå®ç°**ï¼š

**1. é…ç½®ç±»** (`common/config/WechatPayConfig.java`)ï¼š
```java
@Configuration
@ConfigurationProperties(prefix = "wechat.pay")
@Data
public class WechatPayConfig {
    private String appId;
    private String mchId;
    private String apiV3Key;
    private String merchantSerialNumber;
    private String privateKeyPath;
    private String notifyUrl;

    @Bean
    public RSAAutoCertificateConfig rsaAutoCertificateConfig() {
        return new RSAAutoCertificateConfig.Builder()
                .merchantId(mchId)
                .privateKeyFromPath(privateKeyPath)
                .merchantSerialNumber(merchantSerialNumber)
                .apiV3Key(apiV3Key)
                .build();
    }
}
```

**2. æ”¯ä»˜æœåŠ¡ç±»** (`common/service/WechatPayService.java`)ï¼š
```java
@Service
@RequiredArgsConstructor
@Slf4j
public class WechatPayService {

    private final WechatPayConfig wechatPayConfig;
    private final RSAAutoCertificateConfig certificateConfig;
    private final OrderService orderService;

    /**
     * åˆ›å»ºæ”¯ä»˜è®¢å•ï¼ˆJSAPIæ”¯ä»˜ï¼‰
     * @param orderNo è®¢å•å·
     * @param amount æ”¯ä»˜é‡‘é¢ï¼ˆåˆ†ï¼‰
     * @param description å•†å“æè¿°
     * @param openid ç”¨æˆ·openid
     * @return é¢„æ”¯ä»˜äº¤æ˜“ä¼šè¯æ ‡è¯†ï¼ˆç”¨äºå‰ç«¯è°ƒèµ·æ”¯ä»˜ï¼‰
     */
    public Map<String, String> createOrder(String orderNo, Integer amount,
                                          String description, String openid) {
        try {
            // æ„å»ºè¯·æ±‚å‚æ•°
            JsapiPaymentRequest request = new JsapiPaymentRequest();
            request.setAppid(wechatPayConfig.getAppId());
            request.setMchid(wechatPayConfig.getMchId());
            request.setDescription(description);
            request.setOutTradeNo(orderNo);
            request.setNotifyUrl(wechatPayConfig.getNotifyUrl());

            // é‡‘é¢ä¿¡æ¯
            Amount amountInfo = new Amount();
            amountInfo.setTotal(amount);  // å•ä½ï¼šåˆ†
            amountInfo.setCurrency("CNY");
            request.setAmount(amountInfo);

            // ç”¨æˆ·æ ‡è¯†
            Payer payer = new Payer();
            payer.setOpenid(openid);
            request.setPayer(payer);

            // è°ƒç”¨å¾®ä¿¡æ”¯ä»˜API
            NativePayService payService = new NativePayService.Builder()
                    .config(certificateConfig)
                    .build();

            PrepayResponse response = payService.prepay(request);
            String prepayId = response.getPrepayId();

            // ç”Ÿæˆå‰ç«¯è°ƒèµ·æ”¯ä»˜çš„å‚æ•°
            return generateJsapiPayParams(prepayId);
        } catch (Exception e) {
            log.error("åˆ›å»ºæ”¯ä»˜è®¢å•å¤±è´¥: orderNo={}", orderNo, e);
            throw new BusinessException("åˆ›å»ºæ”¯ä»˜è®¢å•å¤±è´¥");
        }
    }

    /**
     * ç”ŸæˆJSAPIæ”¯ä»˜å‚æ•°
     */
    private Map<String, String> generateJsapiPayParams(String prepayId) {
        String timestamp = String.valueOf(System.currentTimeMillis() / 1000);
        String nonceStr = UUID.randomUUID().toString().replace("-", "");
        String packageStr = "prepay_id=" + prepayId;

        // æŒ‰ç…§å¾®ä¿¡è§„èŒƒè®¡ç®—ç­¾å
        String signStr = wechatPayConfig.getAppId() + "\n" +
                        timestamp + "\n" +
                        nonceStr + "\n" +
                        packageStr + "\n";

        String paySign = rsaSign(signStr);

        return Map.of(
            "timeStamp", timestamp,
            "nonceStr", nonceStr,
            "package", packageStr,
            "signType", "RSA",
            "paySign", paySign
        );
    }

    /**
     * æ”¯ä»˜å›è°ƒå¤„ç†
     * @param requestBody å›è°ƒè¯·æ±‚ä½“
     * @param signature ç­¾å
     * @param nonce éšæœºä¸²
     * @param timestamp æ—¶é—´æˆ³
     * @param serialNumber è¯ä¹¦åºåˆ—å·
     */
    public void handlePaymentNotify(String requestBody, String signature,
                                    String nonce, String timestamp, String serialNumber) {
        try {
            // 1. éªŒè¯ç­¾å
            NotificationParser parser = new NotificationParser(certificateConfig);
            RequestParam requestParam = new RequestParam.Builder()
                    .serialNumber(serialNumber)
                    .nonce(nonce)
                    .signature(signature)
                    .timestamp(timestamp)
                    .body(requestBody)
                    .build();

            Transaction transaction = parser.parse(requestParam, Transaction.class);

            // 2. éªŒè¯è®¢å•çŠ¶æ€
            if ("SUCCESS".equals(transaction.getTradeState())) {
                String orderNo = transaction.getOutTradeNo();
                String transactionId = transaction.getTransactionId();
                Integer amount = transaction.getAmount().getTotal();

                // 3. æ›´æ–°è®¢å•çŠ¶æ€
                orderService.updateOrderPaid(orderNo, transactionId, amount);
                log.info("æ”¯ä»˜æˆåŠŸ: orderNo={}, transactionId={}", orderNo, transactionId);
            }
        } catch (Exception e) {
            log.error("æ”¯ä»˜å›è°ƒå¤„ç†å¤±è´¥", e);
            throw new BusinessException("æ”¯ä»˜å›è°ƒå¤„ç†å¤±è´¥");
        }
    }

    /**
     * æŸ¥è¯¢è®¢å•æ”¯ä»˜çŠ¶æ€
     */
    public String queryOrderStatus(String orderNo) {
        try {
            QueryOrderByOutTradeNoRequest request = new QueryOrderByOutTradeNoRequest();
            request.setMchid(wechatPayConfig.getMchId());
            request.setOutTradeNo(orderNo);

            NativePayService payService = new NativePayService.Builder()
                    .config(certificateConfig)
                    .build();

            Transaction transaction = payService.queryOrderByOutTradeNo(request);
            return transaction.getTradeState();  // SUCCESS, NOTPAY, CLOSEDç­‰
        } catch (Exception e) {
            log.error("æŸ¥è¯¢è®¢å•çŠ¶æ€å¤±è´¥: orderNo={}", orderNo, e);
            return "UNKNOWN";
        }
    }

    /**
     * ç”³è¯·é€€æ¬¾
     */
    public void refund(String orderNo, String refundNo, Integer amount, Integer refundAmount) {
        try {
            CreateRefundRequest request = new CreateRefundRequest();
            request.setOutTradeNo(orderNo);
            request.setOutRefundNo(refundNo);
            request.setReason("ç”¨æˆ·ç”³è¯·é€€æ¬¾");
            request.setNotifyUrl(wechatPayConfig.getNotifyUrl());

            // é‡‘é¢ä¿¡æ¯
            RefundAmount amountInfo = new RefundAmount();
            amountInfo.setTotal(amount);      // åŸè®¢å•é‡‘é¢
            amountInfo.setRefund(refundAmount);  // é€€æ¬¾é‡‘é¢
            amountInfo.setCurrency("CNY");
            request.setAmount(amountInfo);

            // è°ƒç”¨é€€æ¬¾API
            RefundService refundService = new RefundService.Builder()
                    .config(certificateConfig)
                    .build();

            Refund refund = refundService.create(request);
            log.info("é€€æ¬¾ç”³è¯·æˆåŠŸ: refundId={}", refund.getRefundId());
        } catch (Exception e) {
            log.error("é€€æ¬¾å¤±è´¥: orderNo={}, refundNo={}", orderNo, refundNo, e);
            throw new BusinessException("é€€æ¬¾ç”³è¯·å¤±è´¥");
        }
    }
}
```

**3. Controllerå®ç°**ï¼š
```java
@RestController
@RequestMapping("/app/payment")
@RequiredArgsConstructor
public class PaymentController {

    private final WechatPayService wechatPayService;
    private final OrderService orderService;

    // åˆ›å»ºæ”¯ä»˜è®¢å•
    @PostMapping("/create")
    public Result<Map<String, String>> createPayment(@Valid @RequestBody CreatePaymentDTO dto) {
        // 1. åˆ›å»ºä¸šåŠ¡è®¢å•
        OrderInfo order = orderService.createOrder(dto);

        // 2. è°ƒç”¨å¾®ä¿¡æ”¯ä»˜
        Map<String, String> payParams = wechatPayService.createOrder(
            order.getOrderNo(),
            order.getAmount(),
            order.getDescription(),
            dto.getOpenid()
        );

        return Result.success(payParams);
    }

    // æ”¯ä»˜å›è°ƒï¼ˆå¾®ä¿¡æœåŠ¡å™¨è°ƒç”¨ï¼‰
    @PostMapping("/notify")
    public Map<String, String> paymentNotify(
            @RequestBody String requestBody,
            @RequestHeader("Wechatpay-Signature") String signature,
            @RequestHeader("Wechatpay-Nonce") String nonce,
            @RequestHeader("Wechatpay-Timestamp") String timestamp,
            @RequestHeader("Wechatpay-Serial") String serialNumber) {

        try {
            wechatPayService.handlePaymentNotify(requestBody, signature, nonce, timestamp, serialNumber);

            // è¿”å›æˆåŠŸå“åº”
            return Map.of("code", "SUCCESS", "message", "æˆåŠŸ");
        } catch (Exception e) {
            // è¿”å›å¤±è´¥å“åº”
            return Map.of("code", "FAIL", "message", e.getMessage());
        }
    }

    // æŸ¥è¯¢è®¢å•çŠ¶æ€
    @GetMapping("/query/{orderNo}")
    public Result<String> queryOrderStatus(@PathVariable String orderNo) {
        String status = wechatPayService.queryOrderStatus(orderNo);
        return Result.success(status);
    }

    // ç”³è¯·é€€æ¬¾
    @PostMapping("/refund")
    public Result<Void> refund(@Valid @RequestBody RefundDTO dto) {
        OrderInfo order = orderService.getByOrderNo(dto.getOrderNo());

        wechatPayService.refund(
            order.getOrderNo(),
            dto.getRefundNo(),
            order.getAmount(),
            dto.getRefundAmount()
        );

        return Result.success();
    }
}
```

**4. å‰ç«¯è°ƒèµ·æ”¯ä»˜**ï¼ˆå°ç¨‹åºï¼‰ï¼š
```javascript
// è·å–æ”¯ä»˜å‚æ•°
const response = await wx.request({
  url: '/app/payment/create',
  method: 'POST',
  data: {
    courseId: 1,
    amount: 9900,  // 99å…ƒ
    openid: wx.getStorageSync('openid')
  }
});

const payParams = response.data.data;

// è°ƒèµ·å¾®ä¿¡æ”¯ä»˜
wx.requestPayment({
  timeStamp: payParams.timeStamp,
  nonceStr: payParams.nonceStr,
  package: payParams.package,
  signType: payParams.signType,
  paySign: payParams.paySign,
  success(res) {
    wx.showToast({ title: 'æ”¯ä»˜æˆåŠŸ' });
    // è·³è½¬åˆ°è®¢å•è¯¦æƒ…
  },
  fail(err) {
    wx.showToast({ title: 'æ”¯ä»˜å¤±è´¥', icon: 'none' });
  }
});
```

#### 4.3.3 å®ç°åŠŸèƒ½æ¸…å•

| åŠŸèƒ½ | æ¥å£è·¯å¾„ | çŠ¶æ€ | è¯´æ˜ |
|------|---------|------|------|
| åˆ›å»ºæ”¯ä»˜è®¢å• | `POST /app/payment/create` | ğŸš€ å¯é€‰ | JSAPI/Nativeæ”¯ä»˜ |
| æ”¯ä»˜å›è°ƒå¤„ç† | `POST /app/payment/notify` | ğŸš€ å¯é€‰ | å¾®ä¿¡æœåŠ¡å™¨è°ƒç”¨ |
| æŸ¥è¯¢è®¢å•çŠ¶æ€ | `GET /app/payment/query/{orderNo}` | ğŸš€ å¯é€‰ | ä¸»åŠ¨æŸ¥è¯¢ |
| ç”³è¯·é€€æ¬¾ | `POST /app/payment/refund` | ğŸš€ å¯é€‰ | 7å¤©å†…å¯é€€ |
| é€€æ¬¾å›è°ƒå¤„ç† | `POST /app/payment/refund-notify` | ğŸš€ å¯é€‰ | å¾®ä¿¡æœåŠ¡å™¨è°ƒç”¨ |

---

## äº”ã€é¡¹ç›®å®ç°åŠŸèƒ½æ¸…å•

### 5.1 å·²å®ç°åŠŸèƒ½ï¼ˆâœ…ï¼‰

| æ¨¡å— | åŠŸèƒ½ | æ¶‰åŠæŠ€æœ¯ | å®ç°ä½ç½® |
|------|------|---------|---------|
| **ç”¨æˆ·ç®¡ç†** | ç”¨æˆ·æ³¨å†Œ/ç™»å½• | JWT + Redis | `web-app/controller/AuthController` |
| **ç”¨æˆ·ç®¡ç†** | Tokené»‘åå•ç®¡ç† | Redis String | `AuthService.logout()` |
| **ç”¨æˆ·ç®¡ç†** | ç”¨æˆ·æ³¨é”€å®¡æ ¸ | MyBatis-Plus | `web-admin/controller/UserController` |
| **è§’è‰²ç®¡ç†** | è§’è‰²åˆ†é…/æƒé™ç®¡ç† | MyBatis-Plus | `web-admin/controller/RoleController` |
| **æ•™ç»ƒç®¡ç†** | æ•™ç»ƒèµ„æ ¼ç”³è¯·/å®¡æ ¸ | MyBatis-Plus + çŠ¶æ€æœº | `CoachCertificationController` |
| **æ•™ç»ƒç®¡ç†** | æ•™ç»ƒç¦»èŒç”³è¯· | MyBatis-Plus | `CoachResignationController` |
| **æ•™ç»ƒç®¡ç†** | æ•™ç»ƒæ—¥ç¨‹å®‰æ’ | MyBatis-Plus | `CoachScheduleController` |
| **æ•™ç»ƒç®¡ç†** | æ•™ç»ƒå’¨è¯¢æœåŠ¡ | MyBatis-Plus | `CoachConsultationController` |
| **é—¨åº—ç®¡ç†** | é—¨åº—CRUDæ“ä½œ | MyBatis-Plus | `web-admin/controller/GymStoreController` |
| **é—¨åº—ç®¡ç†** | é—¨åº—å›¾ç‰‡ä¸Šä¼  | MinIO | `GymStoreController.uploadImage()` |
| **é—¨åº—ç®¡ç†** | é—¨åº—è¯¦æƒ…JSONè§£æ | MySQL JSON + Jackson | `GymStoreService` |
| **é—¨åº—æŸ¥è¯¢** | é™„è¿‘é—¨åº—æŸ¥è¯¢ | Haversineå…¬å¼ + SQL | `AppGymStoreController.nearby()` |
| **é—¨åº—æŸ¥è¯¢** | è·ç¦»è®¡ç®— | Haversineå…¬å¼ | `AppGymStoreService.calculateDistance()` |
| **é—¨åº—æŸ¥è¯¢** | é—¨åº—æœç´¢ | MyBatis-Plus | `AppGymStoreService.searchStores()` |
| **APIæ–‡æ¡£** | Swaggeråˆ†ç»„ç®¡ç† | Knife4j | `Knife4jConfiguration` |
| **æ•°æ®åº“** | é€»è¾‘åˆ é™¤ | MyBatis-Plus @TableLogic | `BaseEntity.isDeleted` |
| **æ•°æ®åº“** | è‡ªåŠ¨å¡«å…… | MyBatis-Plus MetaObjectHandler | `MyMetaObjectHandler` |
| **æ•°æ®åº“** | åˆ†é¡µæŸ¥è¯¢ | MyBatis-Plus Page | æ‰€æœ‰Service |

### 5.2 å¾…é›†æˆåŠŸèƒ½ï¼ˆğŸ”§ï¼‰

| æ¨¡å— | åŠŸèƒ½ | æ¶‰åŠæŠ€æœ¯ | ä¼˜å…ˆçº§ |
|------|------|---------|--------|
| **åœ°å›¾æœåŠ¡** | åœ°å€è½¬åæ ‡ | é«˜å¾·åœ°å›¾API | P1 |
| **åœ°å›¾æœåŠ¡** | åæ ‡è½¬åœ°å€ | é«˜å¾·åœ°å›¾API | P1 |
| **åœ°å›¾æœåŠ¡** | å®é™…è·ç¦»è®¡ç®— | é«˜å¾·åœ°å›¾API | P2 |
| **åœ°å›¾æœåŠ¡** | è·¯å¾„è§„åˆ’ | é«˜å¾·åœ°å›¾API | P2 |
| **åœ°å›¾æœåŠ¡** | å‰ç«¯åœ°å›¾å±•ç¤º | é«˜å¾·åœ°å›¾JS API | P2 |
| **çŸ­ä¿¡æœåŠ¡** | éªŒè¯ç å‘é€ | é˜¿é‡Œäº‘SMS | P1 |
| **çŸ­ä¿¡æœåŠ¡** | éªŒè¯ç æ ¡éªŒ | Redis + é˜¿é‡Œäº‘SMS | P1 |
| **æ”¯ä»˜æœåŠ¡** | å¾®ä¿¡æ”¯ä»˜ | å¾®ä¿¡æ”¯ä»˜V3 API | P3 |
| **æ”¯ä»˜æœåŠ¡** | æ”¯ä»˜å®æ”¯ä»˜ | æ”¯ä»˜å®SDK | P3 |
| **ç¼“å­˜ä¼˜åŒ–** | çƒ­ç‚¹æ•°æ®ç¼“å­˜ | Redis + Spring Cache | P2 |
| **ç¼“å­˜ä¼˜åŒ–** | åˆ†å¸ƒå¼é” | Redis SETNX | P2 |
| **æ•°æ®åº“ä¼˜åŒ–** | ç©ºé—´ç´¢å¼• | MySQL SPATIAL INDEX | P2 |

**ä¼˜å…ˆçº§è¯´æ˜**ï¼š
- **P1ï¼ˆé«˜ï¼‰**ï¼šæ ¸å¿ƒä¸šåŠ¡å¿…éœ€ï¼Œå»ºè®®ä¼˜å…ˆé›†æˆ
- **P2ï¼ˆä¸­ï¼‰**ï¼šå¢å¼ºç”¨æˆ·ä½“éªŒï¼ŒæŒ‰éœ€é›†æˆ
- **P3ï¼ˆä½ï¼‰**ï¼šæ‰©å±•åŠŸèƒ½ï¼ŒåæœŸé›†æˆ

### 5.3 æŠ€æœ¯å€ºåŠ¡ä¸ä¼˜åŒ–å»ºè®®

| é—®é¢˜ | å½±å“ | è§£å†³æ–¹æ¡ˆ | å·¥ä½œé‡ |
|------|------|---------|--------|
| å¼€å‘ç¯å¢ƒéªŒè¯ç å›ºå®š | æµ‹è¯•ä¸ä¾¿ | é›†æˆçŸ­ä¿¡æœåŠ¡Mockæ¨¡å¼ | 1å¤© |
| é™„è¿‘é—¨åº—æŸ¥è¯¢æ€§èƒ½ | æ•°æ®é‡å¤§æ—¶æ…¢ | æ·»åŠ MySQLç©ºé—´ç´¢å¼• | 1å¤© |
| å›¾ç‰‡æœªå‹ç¼© | å­˜å‚¨æˆæœ¬é«˜ | é›†æˆå›¾ç‰‡å‹ç¼©å·¥å…· | 2å¤© |
| ç¼ºå°‘æ¥å£é™æµ | æ˜“è¢«æ”»å‡» | å®Œå–„RateLimitæ³¨è§£ | 2å¤© |
| æ—¥å¿—æœªé›†æˆELK | æ’æŸ¥é—®é¢˜å›°éš¾ | é›†æˆLogstash | 3å¤© |
| ç¼ºå°‘ç›‘æ§å‘Šè­¦ | æ•…éšœå‘ç°æ…¢ | é›†æˆPrometheus | 3å¤© |

---

## å…­ã€å®Œæ•´é›†æˆå®æˆ˜æŒ‡å—

### 6.1 å¿«é€Ÿå¯åŠ¨æ¸…å•ï¼ˆå¼€å‘ç¯å¢ƒï¼‰

**æ­¥éª¤1ï¼šç¯å¢ƒå‡†å¤‡**
```bash
# 1. å®‰è£…MySQL 8.0
# 2. å®‰è£…Redis 7.0
# 3. å¯åŠ¨MinIOï¼ˆDockerï¼‰
docker run -d -p 9000:9000 -p 9001:9001 --name minio \
  -e "MINIO_ROOT_USER=minioadmin" \
  -e "MINIO_ROOT_PASSWORD=minioadmin" \
  minio/minio server /data --console-address ":9001"
```

**æ­¥éª¤2ï¼šæ•°æ®åº“åˆå§‹åŒ–**
```bash
# 1. åˆ›å»ºæ•°æ®åº“
mysql -u root -p
CREATE DATABASE fitness_platform CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;

# 2. å¯¼å…¥SQLæ–‡ä»¶
mysql -u root -p fitness_platform < db/fitness_platform.sql
```

**æ­¥éª¤3ï¼šé…ç½®æ–‡ä»¶ä¿®æ”¹**
```yaml
# web-admin/src/main/resources/application.yml
# web-app/src/main/resources/application.yml

spring:
  datasource:
    url: jdbc:mysql://localhost:3306/fitness_platform
    username: root
    password: YOUR_PASSWORD  # ä¿®æ”¹ä¸ºå®é™…å¯†ç 

  data:
    redis:
      host: localhost
      password: YOUR_PASSWORD  # ä¿®æ”¹ä¸ºå®é™…å¯†ç 

minio:
  endpoint: http://localhost:9000
  access-key: minioadmin
  secret-key: minioadmin
```

**æ­¥éª¤4ï¼šå¯åŠ¨é¡¹ç›®**
```bash
# Adminç«¯
cd web/web-admin
mvn spring-boot:run

# Appç«¯ï¼ˆå¦å¼€ç»ˆç«¯ï¼‰
cd web/web-app
mvn spring-boot:run
```

**æ­¥éª¤5ï¼šéªŒè¯å¯åŠ¨**
```bash
# Adminç«¯Swagger
http://localhost:8080/doc.html

# Appç«¯Swagger
http://localhost:8081/doc.html

# MinIOæ§åˆ¶å°
http://localhost:9001
```

### 6.2 é«˜å¾·åœ°å›¾APIé›†æˆæ­¥éª¤

**æ­¥éª¤1ï¼šç”³è¯·Key**
1. è®¿é—®ï¼šhttps://console.amap.com/dev/key/app
2. åˆ›å»ºåº”ç”¨ï¼Œè·å–Key

**æ­¥éª¤2ï¼šæ·»åŠ é…ç½®**
```yaml
# application.yml
amap:
  api-key: YOUR_AMAP_API_KEY
  web-service-url: https://restapi.amap.com
```

**æ­¥éª¤3ï¼šä½¿ç”¨AmapService**
```java
@Autowired
private AmapService amapService;

// åœ°å€è½¬åæ ‡
Map<String, Double> location = amapService.getLocationByAddress("åŒ—äº¬å¸‚æœé˜³åŒºæœ›äº¬SOHO", "åŒ—äº¬");
// è¿”å›: {latitude: 39.996893, longitude: 116.481488}
```

### 6.3 çŸ­ä¿¡æœåŠ¡é›†æˆæ­¥éª¤

**æ­¥éª¤1ï¼šå¼€é€šé˜¿é‡Œäº‘SMS**
1. è®¿é—®ï¼šhttps://dysms.console.aliyun.com/
2. åˆ›å»ºç­¾åå’Œæ¨¡æ¿

**æ­¥éª¤2ï¼šæ·»åŠ ä¾èµ–**
```xml
<dependency>
    <groupId>com.aliyun</groupId>
    <artifactId>dysmsapi20170525</artifactId>
    <version>2.0.24</version>
</dependency>
```

**æ­¥éª¤3ï¼šæ·»åŠ é…ç½®**
```yaml
aliyun:
  sms:
    access-key-id: YOUR_ACCESS_KEY_ID
    access-key-secret: YOUR_ACCESS_KEY_SECRET
    sign-name: å¥èº«å¹³å°
    template-code: SMS_123456789
```

**æ­¥éª¤4ï¼šä½¿ç”¨SmsService**
```java
@Autowired
private SmsService smsService;

// å‘é€éªŒè¯ç 
smsService.sendVerificationCode("13800138000");

// éªŒè¯éªŒè¯ç 
boolean valid = smsService.verifyCode("13800138000", "123456");
```

### 6.4 å¾®ä¿¡æ”¯ä»˜é›†æˆæ­¥éª¤

**æ­¥éª¤1ï¼šç”³è¯·å•†æˆ·å·**
1. è®¿é—®ï¼šhttps://pay.weixin.qq.com/
2. æäº¤èµ„è´¨è®¤è¯

**æ­¥éª¤2ï¼šä¸‹è½½è¯ä¹¦**
1. ç™»å½•å•†æˆ·å¹³å°
2. ä¸‹è½½APIè¯ä¹¦ï¼ˆapiclient_key.pemï¼‰
3. æ”¾ç½®åˆ° `src/main/resources/cert/`

**æ­¥éª¤3ï¼šæ·»åŠ ä¾èµ–**
```xml
<dependency>
    <groupId>com.github.wechatpay-apiv3</groupId>
    <artifactId>wechatpay-java</artifactId>
    <version>0.2.12</version>
</dependency>
```

**æ­¥éª¤4ï¼šæ·»åŠ é…ç½®**
```yaml
wechat:
  pay:
    app-id: wx1234567890abcdef
    mch-id: 1234567890
    api-v3-key: YOUR_API_V3_KEY
    merchant-serial-number: YOUR_SERIAL_NUMBER
    private-key-path: classpath:cert/apiclient_key.pem
    notify-url: https://yourdomain.com/api/payment/notify
```

**æ­¥éª¤5ï¼šä½¿ç”¨WechatPayService**
```java
@Autowired
private WechatPayService wechatPayService;

// åˆ›å»ºæ”¯ä»˜è®¢å•
Map<String, String> payParams = wechatPayService.createOrder(
    "ORDER123456",
    9900,  // 99å…ƒ
    "è¯¾ç¨‹è´­ä¹°",
    "oUpF8uMuAJO_M2pxb1Q9zNjWeS6o"
);
```

---

## ä¸ƒã€ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²æ¸…å•

### 7.1 ç¯å¢ƒé…ç½®å·®å¼‚

| é…ç½®é¡¹ | å¼€å‘ç¯å¢ƒ | ç”Ÿäº§ç¯å¢ƒ |
|-------|---------|---------|
| æ•°æ®åº“åœ°å€ | localhost | å†…ç½‘IP/åŸŸå |
| Rediså¯†ç  | ç®€å•å¯†ç  | å¼ºå¯†ç  |
| MinIO endpoint | http://localhost:9000 | https://oss.yourdomain.com |
| JWT secret | é»˜è®¤å¯†é’¥ | 256ä½éšæœºå¯†é’¥ |
| æ—¥å¿—çº§åˆ« | DEBUG | INFO/WARN |
| çŸ­ä¿¡Mock | å¯ç”¨ | ç¦ç”¨ |
| é«˜å¾·APIç™½åå• | æœªè®¾ç½® | æœåŠ¡å™¨IP |
| å¾®ä¿¡æ”¯ä»˜å›è°ƒURL | å†…ç½‘ç©¿é€ | æ­£å¼åŸŸå |

### 7.2 å®‰å…¨åŠ å›º

**1. æ•°æ®åº“å®‰å…¨**
```sql
-- åˆ›å»ºä¸“ç”¨æ•°æ®åº“ç”¨æˆ·
CREATE USER 'fitness_app'@'%' IDENTIFIED BY 'STRONG_PASSWORD';
GRANT SELECT, INSERT, UPDATE, DELETE ON fitness_platform.* TO 'fitness_app'@'%';
FLUSH PRIVILEGES;

-- ç¦æ­¢rootè¿œç¨‹ç™»å½•
DELETE FROM mysql.user WHERE User='root' AND Host!='localhost';
```

**2. Rediså®‰å…¨**
```bash
# redis.conf
requirepass YOUR_STRONG_PASSWORD
bind 127.0.0.1  # ä»…å…è®¸æœ¬åœ°è®¿é—®
rename-command FLUSHDB ""  # ç¦ç”¨å±é™©å‘½ä»¤
```

**3. MinIOå®‰å…¨**
```bash
# ä¿®æ”¹é»˜è®¤å¯†é’¥
MINIO_ROOT_USER=admin_custom
MINIO_ROOT_PASSWORD=STRONG_PASSWORD_HERE

# å¯ç”¨HTTPS
./minio server /data --certs-dir /root/.minio/certs
```

**4. æ¥å£å®‰å…¨**
```java
// æ·»åŠ IPç™½åå•æ‹¦æˆªå™¨
@Component
public class IpWhitelistInterceptor implements HandlerInterceptor {

    private static final List<String> WHITELIST = Arrays.asList(
        "127.0.0.1",
        "10.0.0.0/8",  // å†…ç½‘IPæ®µ
        "YOUR_SERVER_IP"
    );

    @Override
    public boolean preHandle(HttpServletRequest request, ...) {
        String clientIp = getClientIP(request);
        if (!isInWhitelist(clientIp)) {
            throw new ForbiddenException("IPæœªæˆæƒ");
        }
        return true;
    }
}
```

### 7.3 æ€§èƒ½ä¼˜åŒ–

**1. MySQLä¼˜åŒ–**
```sql
-- åˆ›å»ºç´¢å¼•
CREATE INDEX idx_user_phone ON user(phone);
CREATE INDEX idx_store_status ON gym_store(status, is_deleted);
CREATE SPATIAL INDEX idx_location ON gym_store(location);

-- æŸ¥è¯¢ä¼˜åŒ–
-- ä½¿ç”¨EXPLAINåˆ†ææ…¢æŸ¥è¯¢
EXPLAIN SELECT * FROM gym_store WHERE status=1 AND is_deleted=0;
```

**2. Redisä¼˜åŒ–**
```yaml
# application-prod.yml
spring:
  data:
    redis:
      lettuce:
        pool:
          max-active: 20  # ç”Ÿäº§ç¯å¢ƒå¢åŠ è¿æ¥æ•°
          max-idle: 10
```

**3. JVMå‚æ•°ä¼˜åŒ–**
```bash
java -jar \
  -Xms2g -Xmx2g \
  -XX:+UseG1GC \
  -XX:MaxGCPauseMillis=200 \
  -XX:+HeapDumpOnOutOfMemoryError \
  fitness-app.jar
```

### 7.4 ç›‘æ§å‘Šè­¦

**é›†æˆPrometheus + Grafana**
```xml
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-actuator</artifactId>
</dependency>
<dependency>
    <groupId>io.micrometer</groupId>
    <artifactId>micrometer-registry-prometheus</artifactId>
</dependency>
```

```yaml
management:
  endpoints:
    web:
      exposure:
        include: health,info,metrics,prometheus
  metrics:
    export:
      prometheus:
        enabled: true
```

### 7.5 å¤‡ä»½ç­–ç•¥

**MySQLå¤‡ä»½**
```bash
# æ¯æ—¥å‡Œæ™¨3ç‚¹å¤‡ä»½
0 3 * * * /usr/bin/mysqldump -u root -p fitness_platform > /backup/db_$(date +\%Y\%m\%d).sql
```

**Rediså¤‡ä»½**
```bash
# å¯ç”¨AOFæŒä¹…åŒ–
appendonly yes
appendfsync everysec

# å®šæ—¶å¤‡ä»½RDB
save 900 1
save 300 10
save 60 10000
```

**MinIOå¤‡ä»½**
```bash
# ä½¿ç”¨mcå·¥å…·åŒæ­¥åˆ°å¦ä¸€å°æœåŠ¡å™¨
mc mirror minio1/fitness-platform minio2/fitness-platform-backup
```

---

## é™„å½•

### A. å¸¸ç”¨å‘½ä»¤é€ŸæŸ¥

**Dockerå‘½ä»¤**
```bash
# å¯åŠ¨MinIO
docker start minio-server

# åœæ­¢MinIO
docker stop minio-server

# æŸ¥çœ‹æ—¥å¿—
docker logs -f minio-server
```

**MySQLå‘½ä»¤**
```bash
# å¯¼å…¥SQL
mysql -u root -p fitness_platform < backup.sql

# å¯¼å‡ºSQL
mysqldump -u root -p fitness_platform > backup.sql

# æŸ¥çœ‹è¿›ç¨‹
SHOW PROCESSLIST;
```

**Rediså‘½ä»¤**
```bash
# æŸ¥çœ‹æ‰€æœ‰key
redis-cli KEYS *

# æŸ¥çœ‹å†…å­˜ä½¿ç”¨
redis-cli INFO memory

# æ¸…ç©ºæ•°æ®åº“ï¼ˆè°¨æ…ï¼‰
redis-cli FLUSHDB
```

### B. æŠ€æœ¯æ”¯æŒèµ„æº

| æŠ€æœ¯ | å®˜æ–¹æ–‡æ¡£ | ç¤¾åŒº |
|------|---------|------|
| Spring Boot | https://spring.io/projects/spring-boot | Stack Overflow |
| MyBatis-Plus | https://baomidou.com/ | GitHub Issues |
| MinIO | https://min.io/docs/minio/linux/index.html | Slack |
| é«˜å¾·åœ°å›¾ | https://lbs.amap.com/api | å¼€å‘è€…è®ºå› |
| é˜¿é‡Œäº‘SMS | https://help.aliyun.com/product/44282.html | å·¥å•ç³»ç»Ÿ |
| å¾®ä¿¡æ”¯ä»˜ | https://pay.weixin.qq.com/wiki/doc/apiv3/index.shtml | å•†æˆ·ç¤¾åŒº |

### C. å¼€å‘è§„èŒƒ

**ä»£ç è§„èŒƒ**
- éµå¾ªé˜¿é‡Œå·´å·´Javaå¼€å‘æ‰‹å†Œ
- ä½¿ç”¨Lombokç®€åŒ–ä»£ç 
- Controlleråªåšå‚æ•°æ ¡éªŒå’Œè°ƒç”¨Service
- Serviceå±‚å¤„ç†ä¸šåŠ¡é€»è¾‘
- å¤æ‚SQLå†™åœ¨Mapper XMLä¸­

**Gitæäº¤è§„èŒƒ**
```
feat: æ–°å¢é—¨åº—ç®¡ç†åŠŸèƒ½
fix: ä¿®å¤Tokenè¿‡æœŸåˆ¤æ–­é€»è¾‘
docs: æ›´æ–°APIæ–‡æ¡£
style: ä»£ç æ ¼å¼åŒ–
refactor: é‡æ„ç”¨æˆ·Service
test: æ·»åŠ å•å…ƒæµ‹è¯•
chore: å‡çº§ä¾èµ–ç‰ˆæœ¬
```

**APIè®¾è®¡è§„èŒƒ**
- RESTfulé£æ ¼
- ç»Ÿä¸€ä½¿ç”¨Resultå°è£…
- HTTPçŠ¶æ€ç è§„èŒƒä½¿ç”¨
- æ¥å£ç‰ˆæœ¬æ§åˆ¶ï¼ˆv1, v2ï¼‰

---

**æ–‡æ¡£ç»´æŠ¤**ï¼š
- æ¯æ¬¡æ–°å¢å¤–éƒ¨æœåŠ¡é›†æˆæ—¶æ›´æ–°æœ¬æ–‡æ¡£
- æ¯æ¬¡æ¶æ„è°ƒæ•´æ—¶æ›´æ–°æ¶æ„å›¾
- æ¯æ¬¡ä¼˜åŒ–é…ç½®æ—¶æ›´æ–°æœ€ä½³å®è·µ

**æ–‡æ¡£ç‰ˆæœ¬å†å²**ï¼š
- v1.0 (2025-01-24): åˆå§‹ç‰ˆæœ¬ï¼Œæ¶µç›–MySQL/Redis/MinIO/é«˜å¾·åœ°å›¾/çŸ­ä¿¡/æ”¯ä»˜

---

**ç»“è¯­**ï¼š
æœ¬æ–‡æ¡£è¯¦ç»†è®°å½•äº†å¥èº«å¹³å°é¡¹ç›®çš„æ‰€æœ‰æŠ€æœ¯æ¶æ„ã€ä¸­é—´ä»¶é›†æˆæ–¹æ¡ˆå’Œå¤–éƒ¨APIé›†æˆæ–¹æ³•ã€‚å»ºè®®å¼€å‘å›¢é˜Ÿï¼š
1. æŒ‰ç…§ä¼˜å…ˆçº§ï¼ˆP1 â†’ P2 â†’ P3ï¼‰é€æ­¥é›†æˆå¤–éƒ¨æœåŠ¡
2. å¼€å‘ç¯å¢ƒå…ˆä½¿ç”¨Mockæ¨¡å¼éªŒè¯æµç¨‹
3. ç”Ÿäº§ç¯å¢ƒä¸¥æ ¼éµå¾ªå®‰å…¨åŠ å›ºæ¸…å•
4. å®šæœŸreviewæŠ€æœ¯å€ºåŠ¡å¹¶ä¼˜åŒ–

å¦‚æœ‰ç–‘é—®ï¼Œè¯·å‚è€ƒå„æŠ€æœ¯çš„å®˜æ–¹æ–‡æ¡£æˆ–è”ç³»æ¶æ„è´Ÿè´£äººã€‚
