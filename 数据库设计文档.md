# 健身平台单表数据库设计文档

## 项目信息
- **项目架构**: Spring Boot 3.0.5 + Vue 3 B/S单体应用
- **数据库框架**: MyBatis-Plus 3.5.3.1
- **数据库**: MySQL 8.0+
- **设计模式**: 单表设计（只有一张表承载所有业务）
- **表名**: `fitness_data`

## 数据库结构

### 1. 主要表结构

#### 1.1 platform_unified (统一业务表)
这是核心的反规范化表，整合了原本44张表的所有功能。

**核心字段分类：**

##### 识别字段
- `id`: 主键ID
- `entity_type`: 实体类型（user/course/order/article等）
- `entity_id`: 业务主键
- `business_code`: 自动生成的业务编号

##### 关联维度
- `user_id`: 用户ID维度
- `coach_id`: 教练ID维度
- `target_id`: 目标对象ID
- `parent_id`: 父级关系ID
- `related_id`: 其他关联键

##### 时间维度
- `occur_date`: 发生日期
- `occur_time`: 发生时间
- `start_time/end_time`: 时间段
- `expire_time`: 过期时间

##### 状态分类
- `status_code`: 状态编码
- `category`: 主分类
- `sub_category`: 子分类
- `tags`: JSON标签数组

##### 数值字段
- `amount`: 主金额
- `original_amount`: 原价
- `discount_amount`: 优惠金额
- `final_amount`: 最终金额
- `quantity`: 数量
- `score`: 评分/权重

##### 文本内容
- `title`: 标题
- `subtitle`: 副标题
- `summary`: 摘要描述
- `content_text`: 正文内容
- `remark`: 备注

##### 多媒体资源
- `cover_image`: 封面图片
- `images`: 图片数组JSON
- `videos`: 视频数组JSON
- `attachments`: 附件信息JSON

##### 业务域JSON字段
- `user_profile`: 用户域数据
- `health_profile`: 健康域数据
- `exercise_domain`: 运动域数据
- `nutrition_domain`: 营养域数据
- `content_domain`: 内容域数据
- `social_domain`: 社交域数据
- `activity_domain`: 活动域数据
- `commerce_domain`: 商务域数据
- `coach_domain`: 教练域数据
- `notification_domain`: 通知域数据
- `analytics_domain`: 分析域数据
- `system_domain`: 系统域数据

##### 位置信息
- `province/city/district`: 行政区划
- `address`: 详细地址
- `longitude/latitude`: 经纬度

##### 扩展字段
- `ext_data`: 业务扩展数据
- `metadata`: 元数据信息
- `config`: 配置信息

##### 审计字段
- `version`: 版本号（乐观锁）
- `create_by/update_by`: 创建人/更新人
- `create_time/update_time`: 创建时间/更新时间
- `is_deleted`: 逻辑删除标识

#### 1.2 sys_config (系统配置表)
存储系统级别的配置参数。

#### 1.3 sys_sequence (序列号生成表)
用于生成各种业务编号（用户编号、订单号、课程编号等）。

### 2. 索引设计

#### 2.1 核心业务索引
- `uk_entity_type_id`: 实体类型+业务ID唯一索引
- `idx_entity_type`: 实体类型索引
- `idx_business_code`: 业务编号索引

#### 2.2 关联维度索引
- `idx_user_id`: 用户ID索引
- `idx_coach_id`: 教练ID索引
- `idx_user_entity_type`: 用户+实体类型复合索引
- `idx_coach_entity_type`: 教练+实体类型复合索引

#### 2.3 时间维度索引
- `idx_occur_date/idx_occur_time`: 时间索引
- `idx_start_end_time`: 时间段索引
- `idx_user_occur_time`: 用户+时间复合索引

#### 2.4 状态分类索引
- `idx_status_code`: 状态索引
- `idx_category`: 分类索引
- `idx_category_status`: 分类+状态复合索引

#### 2.5 业务查询索引
- `idx_user_category_time`: 用户+分类+时间三维索引
- `idx_coach_category_time`: 教练+分类+时间三维索引
- `idx_amount/idx_score`: 数值字段索引

### 3. 视图定义

#### 3.1 v_user_info (用户信息视图)
提供用户基础信息的便捷查询视图。

#### 3.2 v_course_info (课程信息视图)
提供课程基础信息的便捷查询视图。

### 4. 存储过程与触发器

#### 4.1 GenerateBusinessCode (业务编号生成存储过程)
自动生成格式化的业务编号，支持前缀、日期格式、序列号等。

#### 4.2 tr_platform_unified_insert (插入触发器)
在插入数据时自动生成业务编号，设置审计字段。

## 使用方式

### 1. 数据库初始化
```sql
-- 在MySQL中执行
SOURCE fitness_platform_complete.sql;
```

### 2. Spring Boot配置
在`application.yml`中配置：
```yaml
spring:
  datasource:
    url: jdbc:mysql://localhost:3306/fitness_platform?useUnicode=true&characterEncoding=utf8&useSSL=false&serverTimezone=GMT%2B8
    username: your_username
    password: your_password
    driver-class-name: com.mysql.cj.jdbc.Driver

mybatis-plus:
  configuration:
    log-impl: org.apache.ibatis.logging.stdout.StdOutImpl
  global-config:
    db-config:
      logic-delete-field: isDeleted
      logic-delete-value: 1
      logic-not-delete-value: 0
```

### 3. 实体类设计
```java
@TableName("platform_unified")
public class PlatformUnified {
    @TableId(type = IdType.AUTO)
    private Long id;
    
    private String entityType;
    private String entityId;
    private String businessCode;
    
    // 其他字段...
    
    @TableLogic
    private Integer isDeleted;
}
```

### 4. 常用查询示例

#### 4.1 查询用户信息
```sql
SELECT * FROM v_user_info WHERE user_code = 'U20250124000001';
```

#### 4.2 查询用户的课程记录
```sql
SELECT * FROM platform_unified 
WHERE entity_type = 'user_course' AND user_id = 1001 AND is_deleted = 0
ORDER BY create_time DESC;
```

#### 4.3 查询教练的收入统计
```sql
SELECT 
    coach_id,
    DATE(occur_date) as stat_date,
    SUM(amount) as total_income
FROM platform_unified 
WHERE entity_type = 'coach_income' 
  AND coach_id = 2001 
  AND occur_date >= '2025-01-01'
  AND is_deleted = 0
GROUP BY coach_id, DATE(occur_date);
```

## 注意事项

1. **JSON字段查询**: 使用MySQL的JSON函数进行查询
   ```sql
   SELECT * FROM platform_unified 
   WHERE JSON_EXTRACT(user_profile, '$.email') = 'user@example.com';
   ```

2. **分页查询**: 利用复合索引进行高效分页
   ```sql
   SELECT * FROM platform_unified 
   WHERE entity_type = 'article' AND is_deleted = 0
   ORDER BY create_time DESC 
   LIMIT 20 OFFSET 0;
   ```

3. **数据一致性**: 虽然是反规范化设计，但要注意维护数据的逻辑一致性。

4. **索引维护**: 定期分析查询性能，根据实际使用情况调整索引。

5. **存储空间**: JSON字段会占用较多存储空间，定期清理无用数据。

## 扩展建议

1. **缓存策略**: 对热点数据使用Redis缓存
2. **读写分离**: 考虑使用MySQL主从复制
3. **数据归档**: 定期归档历史数据
4. **监控告警**: 设置数据库性能监控

---

**版本**: 1.0.0  
**更新日期**: 2025-01-24  
**维护人**: Senior Java Architect