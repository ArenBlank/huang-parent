<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.huang.mapper.AdminCoachScheduleChangeMapper">

    <!-- 分页查询教练日程变更申请 -->
    <select id="selectCoachScheduleChangePageForAdmin" resultType="com.huang.vo.AdminCoachScheduleChangeDetailVO">
        SELECT 
            c.id,
            c.coach_id,
            co.real_name as coach_name,
            u.phone as coach_phone,
            c.change_type,
            CASE 
                WHEN c.change_type = 'leave' THEN '请假'
                WHEN c.change_type = 'overtime' THEN '加班'
                WHEN c.change_type = 'adjust' THEN '调整'
                ELSE c.change_type
            END as change_type_name,
            c.original_date,
            c.original_start_time,
            c.original_end_time,
            c.new_date,
            c.new_start_time,
            c.new_end_time,
            c.reason,
            c.status,
            CASE 
                WHEN c.status = 'pending' THEN '待审核'
                WHEN c.status = 'approved' THEN '已批准'
                WHEN c.status = 'rejected' THEN '已拒绝'
                ELSE c.status
            END as status_name,
            c.apply_time,
            c.review_time,
            c.reviewer_id,
            ru.username as reviewer_name,
            c.review_remark,
            c.create_time,
            c.update_time
        FROM coach_schedule_change c
        LEFT JOIN coach co ON c.coach_id = co.id
        LEFT JOIN user u ON co.user_id = u.id
        LEFT JOIN user ru ON c.reviewer_id = ru.id
        WHERE c.is_deleted = 0
        <if test="query.coachId != null">
            AND c.coach_id = #{query.coachId}
        </if>
        <if test="query.coachName != null and query.coachName != ''">
            AND co.real_name LIKE CONCAT('%', #{query.coachName}, '%')
        </if>
        <if test="query.status != null and query.status != ''">
            AND c.status = #{query.status}
        </if>
        <if test="query.changeType != null and query.changeType != ''">
            AND c.change_type = #{query.changeType}
        </if>
        <if test="query.applyStartDate != null">
            <![CDATA[AND DATE(c.apply_time) >= #{query.applyStartDate}]]>
        </if>
        <if test="query.applyEndDate != null">
            <![CDATA[AND DATE(c.apply_time) <= #{query.applyEndDate}]]>
        </if>
        <if test="query.originalStartDate != null">
            <![CDATA[AND c.original_date >= #{query.originalStartDate}]]>
        </if>
        <if test="query.originalEndDate != null">
            <![CDATA[AND c.original_date <= #{query.originalEndDate}]]>
        </if>
        ORDER BY 
            CASE WHEN c.status = 'pending' THEN 0 ELSE 1 END,
            c.apply_time DESC
    </select>

    <!-- 根据ID查询教练日程变更申请详情 -->
    <select id="selectCoachScheduleChangeDetailForAdmin" resultType="com.huang.vo.AdminCoachScheduleChangeDetailVO">
        SELECT 
            c.id,
            c.coach_id,
            co.real_name as coach_name,
            u.phone as coach_phone,
            c.change_type,
            CASE 
                WHEN c.change_type = 'leave' THEN '请假'
                WHEN c.change_type = 'overtime' THEN '加班'
                WHEN c.change_type = 'adjust' THEN '调整'
                ELSE c.change_type
            END as change_type_name,
            c.original_date,
            c.original_start_time,
            c.original_end_time,
            c.new_date,
            c.new_start_time,
            c.new_end_time,
            c.reason,
            c.status,
            CASE 
                WHEN c.status = 'pending' THEN '待审核'
                WHEN c.status = 'approved' THEN '已批准'
                WHEN c.status = 'rejected' THEN '已拒绝'
                ELSE c.status
            END as status_name,
            c.apply_time,
            c.review_time,
            c.reviewer_id,
            ru.username as reviewer_name,
            c.review_remark,
            c.create_time,
            c.update_time
        FROM coach_schedule_change c
        LEFT JOIN coach co ON c.coach_id = co.id
        LEFT JOIN user u ON co.user_id = u.id
        LEFT JOIN user ru ON c.reviewer_id = ru.id
        WHERE c.is_deleted = 0 AND c.id = #{id}
    </select>

</mapper>